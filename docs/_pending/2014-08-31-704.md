---
title: "Log de \"iptables\" con NFLOG vs ULOG"
date: "2014-08-31"
categories: 
  - "gentoo"
tags: 
  - "iptables"
  - "linux"
  - "seguridad"
---

Esta frase bien podría ser una cita Geek: "Registrar lo que pasa es de sabios...", así que este apunte va de "log". En el pasado usaba ULOG para analizar qué paquetes eran descartados por IPTABLES, pero como ULOG ha sido marcado como obsoleto en el Kernel, he cambiado mi configuración a NFLOG.

[![imagenes_web111](https://www.luispa.com/wp-content/uploads/2014/12/imagenes_web111.jpg)](https://www.luispa.com/wp-content/uploads/2014/12/imagenes_web111.jpg)

## Configuración del kernel

Configurar lo siguiente en el Kernel:

 
- CONFIG\_NETFILTER\_NETLINK\_LOG=y # Log packets via NFNETLINK interface
- CONFIG\_NETFILTER\_XT\_TARGET\_NFLOG=y # Enables NFLOG target (allows log through nfnetlink\_log)
- CONFIG\_NETFILTER\_XT\_TARGET\_LOG=y # Enables LOG target (allows log through syslog) OLD METHOD
- CONFIG\_IP\_NF\_TARGET\_ULOG=n # "unset" OLD ULOG Target
 

 

### CONFIG\_NETFILTER\_NETLINK\_LOG

Activamos la opción de hacer Logging a través de NFNETLINK, es la opción nueva que permitirá trabajar con el target NFLOG

 
Symbol: NETFILTER\_NETLINK\_LOG \[=y\]
Prompt: Netfilter LOG over NFNETLINK interface
 -> Networking support (NET \[=y\])
 -> Networking options
 -> Network packet filtering framework (Netfilter) (NETFILTER \[=y\])
 -> Core Netfilter Configuration
 {\*} Netfilter LOG over NFNETLINK interface
 

 

### CONFIG\_NETFILTER\_XT\_TARGET\_NFLOG

Target NFLOG, para que podamos usarlo con iptables.

 
Symbol: NETFILTER\_XT\_TARGET\_NFLOG \[=m\] 
Prompt: "NFLOG" target support
 -> Networking support (NET \[=y\]) 
 -> Networking options
 -> Network packet filtering framework (Netfilter) (NETFILTER \[=y\]) 
 -> Core Netfilter Configuration
 -> Netfilter Xtables support (required for ip\_tables) (NETFILTER\_XTABLES \[=y\]) 
 <\*> "NFLOG" target support
 

 

### CONFIG\_NETFILTER\_XT\_TARGET\_LOG

Se trata del método antiguo usado para hacer logging al SYSLOG. Ya no lo necesito, así que lo he desactivado:

 
Symbol: NETFILTER\_XT\_TARGET\_LOG \[=y\]
Prompt: LOG target support
 -> Networking support (NET \[=y\])
 -> Networking options 
 -> Network packet filtering framework (Netfilter) (NETFILTER \[=y\]) 
 -> Core Netfilter Configuration 
 -> Netfilter Xtables support (required for ip\_tables) (NETFILTER\_XTABLES \[=y\])
 < > LOG target support
 

 

### CONFIG\_NETFILTER\_XT\_TARGET\_LOG (OBSOLETO)

Este es el antiguo ULOG, que al quedar obsoleto también he desactivado

 
Symbol: IP\_NF\_TARGET\_ULOG \[=n\] 
Prompt: ULOG target support (obsolete) 
 -> Networking support (NET \[=y\])
 -> Networking options
 -> Network packet filtering framework (Netfilter) (NETFILTER \[=y\])
 -> IP: Netfilter Configuration
 -> IP tables support (required for filtering/masq/NAT) (IP\_NF\_IPTABLES \[=y\])
 < > ULOG target support (obsolete)
 

 

## Programa ULOG

No olvides que tienes que instalar ULOG y configurarlo

 
emerge -v ulogd

Fichero de configuración:

\[global\]
logfile="/var/log/ulogd/ulogd.log"
loglevel=5
plugin="/usr/lib64/ulogd/ulogd\_inppkt\_NFLOG.so"
plugin="/usr/lib64/ulogd/ulogd\_inpflow\_NFCT.so"
plugin="/usr/lib64/ulogd/ulogd\_filter\_IFINDEX.so"
plugin="/usr/lib64/ulogd/ulogd\_filter\_IP2STR.so"
plugin="/usr/lib64/ulogd/ulogd\_filter\_IP2BIN.so"
plugin="/usr/lib64/ulogd/ulogd\_filter\_PRINTPKT.so"
plugin="/usr/lib64/ulogd/ulogd\_filter\_HWHDR.so"
plugin="/usr/lib64/ulogd/ulogd\_filter\_PRINTFLOW.so"
plugin="/usr/lib64/ulogd/ulogd\_output\_LOGEMU.so"
plugin="/usr/lib64/ulogd/ulogd\_output\_SYSLOG.so"
plugin="/usr/lib64/ulogd/ulogd\_output\_XML.so"
plugin="/usr/lib64/ulogd/ulogd\_output\_GPRINT.so"
plugin="/usr/lib64/ulogd/ulogd\_raw2packet\_BASE.so"
plugin="/usr/lib64/ulogd/ulogd\_inpflow\_NFACCT.so"
plugin="/usr/lib64/ulogd/ulogd\_output\_GRAPHITE.so"
stack=log1:NFLOG,base1:BASE,ifi1:IFINDEX,ip2str1:IP2STR,print1:PRINTPKT,emu1:LOGEMU
stack=log2:NFLOG,base1:BASE,ifi1:IFINDEX,ip2str1:IP2STR,print1:PRINTPKT,emu2:LOGEMU
stack=log3:NFLOG,base1:BASE,ifi1:IFINDEX,ip2str1:IP2STR,print1:PRINTPKT,emu3:LOGEMU
stack=log4:NFLOG,base1:BASE,ifi1:IFINDEX,ip2str1:IP2STR,print1:PRINTPKT,emu4:LOGEMU
:
\[log1\]
group=0
\[log2\]
group=1 # Group has to be different from the one use in log1
\[log3\]
group=2 # Group has to be different from the one use in log1/log2
numeric\_label=1 # you can label the log info based on the packet verdict
\[log4\]
group=3 # Group has to be different from the one use in log1/log2
:
\[emu1\]
file="/var/log/ulogd/iptables\_all.log"
sync=1
\[emu2\]
file="/var/log/ulogd/iptables\_drop.log"
sync=1
\[emu3\]
file="/var/log/ulogd/iptables\_dropblacklist.log"
sync=1
\[emu4\]
file="/var/log/ulogd/iptables\_dnat.log"
 

 

## Ejemplo de uso con IPTABLES

Sección de un script donde añado una regla para hacer drop de ciertas IP's de una supuesta blacklist:

 
 :
 # Prefijos que bloqueo de forma especifica
 export LOGDROPBLACKLIST="yes" 
 export BLACKLIST="
 190.55.85.0/24 \\
 190.55.95.0/24 \\
 190.55.98.0/24 \\
 95.211.100.0/24 \\
 63.217.28.226 \\
 194.179.126.151 \\
 216.151.130.170 \\
 62.109.4.89 \\
 192.168.1.17 \\
 "
:
# === Creo el CHAIN "BlackList" para bloquear ciertas IP's...
 iptables -N BlackList
:
# === Redirigir al CHANIN paquetes con IP's del BlackList
 for blacklist in $BLACKLIST
 do
 iptables -A INPUT -s $blacklist -j BlackList
 iptables -A FORWARD -s $blacklist -j BlackList
 done
:
 # === Hacer LOGGING de dichos paquetes
 if \[ "${LOGBLACKLIST}" = "yes" \]; then
 iptables -A BlackList -j NFLOG --nflog-group 2 --nflog-prefix "BlackList -- DROP "
 fi
 
 # === Finalmente hacer DROP de los paquetes
 iptables -A BlackList -j DROP
 
 :
 =====

 

### Mostrar logging

 
tail -f /var/log/ulog/iptables\_drop.log
