---
title: "Servidor DHCP y PiHole"
date: "2023-12-21"
categories: administración
tags: domótica networking avanzado linux pve proxmox ubuntu dhcp dns
excerpt_separator: <!--more-->
---

![Logo CRLF](/assets/img/posts/logo-dnsmasq.svg){: width="150px" style="float:left; padding-right:25px" }

En este apunte describo cómo he configurado mi servidor DHCP y DNS casero. Antiguamente tenía un servidor linux como router de internet y en otra máquina virtual tenía [PiHole]]({% post_url 2021-06-20-pihole-casero %}). He decido migrar a una configuración híbrida, pasando el DNS y DHCP de la intranet casera al router y dejando a PiHole exclusivamente como el sumidero de la publicidad.

Me he dado cuenta que ante cualquier mínimo fallo del PiHole el resto de servicios de la casa dejan de funcionar. DHCP y DNS no pueden fallar o todo falla. Al moverlo al router principal, quedan completamente vinculados. Si falla el router obviamente todo va a fallar pero por lo menos se dónde está el punto de fallo.

<br clear="left"/>
<!--more-->

## Introducción

Tengo un dominio inventado llamado `.parchis.org` que uso solo en casa y que poco a poco voy a ir migrando `.home.arpa` ([RFC 8375](https://www.rfc-editor.org/rfc/rfc8375.html). Mis servidores importantes son:

- `cortafuegix.parchis.org`: Es el router de internet, basado en Ubuntu, utiliza PPPoE para conectar a internet y tiene las direcciones en la intranet: 192.168.100.1/22.
- `pihole.parchis.org`: Actualmente es el DNS y DHCP basado en el software PiHole, ejecutándose tambien en una VM con Ubuntu, sus direcciones en la intranet son 192.168.100.224/22.

He decidido instalar `dnsmasq.d` en `cortafuegix`, porque ofrece DHCP y DNS, es sencillo, rápido y fácil de mantener. Resolverá ambos dominios, y el resto de consultas las redirigirá al PiHole que hace de sumidero de la publicidad, y este a su vez a un servidor DNS upstream (en mi caso tengo configurado PiHole para que use OpenDNS).

{% include showImagen.html
      src="/assets/img/posts/2023-12-31-dnsmasq.01.svg"
      caption="Arquitectura Pi-hole"
      width="500px"
      %}

## Instalación en `cortafuegix`

Empiezo por una instalacion mínima para comprobar que funciona

```bash
apt update -y && apt upgrade -y && apt full-upgrade -y
apt install -y dnsmasq dnsutils ldnsutils
```

Es normal que falle al intentar arrancar el servicio. Se debe a que ya hay un servicio escuchando en el puerto 53, se trata de `systemd-resolved`, lo resuelvo más tarde. Empiezo por el `/etc/dnsmasq.conf`, para indicar que cargue cualquier fichero que encuentre bajo `/etc/dnsmasq.d`

```conf
$ cat /etc/dnsmasq.conf
conf-dir=/etc/dnsmasq.d
```

Creo varios archivos bajo `/etc/dnsmasq.d`. Notar que tengo un par de vlan's, la 100 y la 205. Le estoy diciendo que solo escuche en esas dos interfaces explícitamente, por lo que solo escuchará en las IP's en las que ha hecho bind. Además le doy la IP de `pihole` como `server` (se convierte en su forwarder)

```bash
$ cat /etc/dnsmasq.d/000.dnsmasq.conf
domain-needed
bogus-priv
server=192.168.100.224
local=/parchis.org/
local=/home.arpa/
interface=vlan100
interface=lo
bind-interfaces
expand-hosts
domain=parchis.org
dhcp-authoritative
log-facility=/var/log/dnsmasq.log
log-queries
log-async
cache-size=10000
no-hosts
addn-hosts=/etc/hosts.home.arpa
addn-hosts=/etc/hosts.parchis.org
edns-packet-max=1232
server=/test/
server=/localhost/
server=/invalid/
server=/bind/
server=/onion/
```

Creo el fichero `/etc/dnsmasq.d/100-vlan.conf` y `/etc/dnsmasq.d/205-vlan.conf` que serán cargados e interpretados, para configurar DHCP.

```bash
$ cat /etc/dnsmasq.d/100-vlan.conf
:
####
#### Ejemplo para Access Points
####
dhcp-option=capwap,option:router,192.168.100.1
dhcp-option=capwap,option:dns-server,192.168.100.1
dhcp-option=capwap,option:netmask,255.255.252.0
dhcp-option=capwap,43,192.168.252.238
dhcp-host=set:capwap,12:34:56:78:16:10,ap-paso.parchis.org,192.168.100.220
dhcp-host=set:capwap,12:34:56:78:57:48,ap-buhardilla.parchis.org,192.168.100.221
dhcp-host=set:capwap,12:34:56:78:35:F8,ap-cuartos.parchis.org,192.168.100.222

####
#### Ejemplo de Rango dinámicas
####
dhcp-range=set:vlan100,192.168.100.100,192.168.100.199,1h
dhcp-option=set:vlan100,option:router,192.168.100.1
dhcp-option=set:vlan100,option:dns-server,192.168.100.1
dhcp-option=set:vlan100,option:netmask,255.255.252.0

####
#### Ejemplo de asignaciones estáticas
####
dhcp-host=set:vlan100,12:34:56:77:0E:A1,192.168.100.2,panoramix.parchis.org
dhcp-host=set:vlan100,12:34:56:70:49:ED,192.168.100.3,idefix.parchis.org
dhcp-host=set:vlan100,12:34:56:75:0d:20,192.168.100.4,idefix-wifi.parchis.org
dhcp-host=set:vlan100,12:34:56:75:df:41,192.168.100.5,kymera.parchis.org
:
```

```bash
$ cat /etc/dnsmasq.d/205-vlan.conf
####
#### Ejemplo para decos
####
dhcp-range=set:decos,192.168.205.200,192.168.205.223,1h
dhcp-host=set:decos,12:34:56:77:5b:06,deco205-uno-eth,192.168.205.225
dhcp-host=set:decos,12:34:56:77:66:04,deco205-dos-eth,192.168.205.226
dhcp-option=set:decos,option:router,192.168.205.1
dhcp-option=set:decos,option:netmask,255.255.255.0
dhcp-option=set:decos,option:dns-server,172.26.23.3
dhcp-option=set:decos,240,':::::239.0.2.10:22222:v6.0:239.0.2.30:22222'
```

Configuro que las consultas DNS de él mismo se las haga a si mismo (`127.0.0.1`), modifico el fichero netplan para que su nameserver sea él mismo, además deshabilito que se instale el dominio de búsqueda que me llega por la vlan3 vía dhcp.

```yaml
$ cat /etc/netplan/netplan.yaml
:
      # Movistar VoIP
      vlan3:
:
        dhcp4-overrides:
          use-routes: false
          use-dns: false
          use-domains: false
:
      # Vlan principal
      vlan100:
        id: 100
        link: eth0
        macaddress: "62:54:55:44:01:30"
        addresses:
        - 192.168.100.1/21
        nameservers:
          addresses:
          - 127.0.0.1
          search:
          - parchis.org
:
```

Reconfiguro `systemd-resolved` para que no haga un bind al puerto 53. En principio no hace falta (porque lo hace a una IP distinta, la 127.0.0.53), pero al hacerlo evito que internamente el propio `cortafuegix` cuando necesite resolver le pida a `dnsmasq` consultas a la `127.0.0.53:53` y la `127.0.0.1:53` (dos veces a sí mismo).

```bash
$ cat /etc/systemd/resolved.conf
[Resolve]
DNSStubListener=no

$ systemctl restart systemd-resolved
```

Ya puedo arrancar el servicio y compruebar el estado. Nota: justo antes de este paso he cambiado la configuracion de mi PiHole para que deje de servir DHCP en la red y eliminado todas las entradas locales DNS que tenía. Recuerda que no debes tener dos dhcp servers en la misma red.

```bash
systemctl start dnsmasq.service
systemctl status dnsmasq.service
● dnsmasq.service - dnsmasq - A lightweight DHCP and caching DNS server
     Loaded: loaded (/lib/systemd/system/dnsmasq.service; enabled; vendor preset: enabled)
     Active: active (running) since Tue 2024-12-24 16:40:01 CET; 2min 13s ago
    Process: 5591 ExecStartPre=/etc/init.d/dnsmasq checkconfig (code=exited, status=0/SUCCESS)
    Process: 5599 ExecStart=/etc/init.d/dnsmasq systemd-exec (code=exited, status=0/SUCCESS)
    Process: 5608 ExecStartPost=/etc/init.d/dnsmasq systemd-start-resolvconf (code=exited, status=0/SUCCESS)
    :
```

Verifico que `dnsmasq` está escuchando en el puerto 53 en las interfaces vlan100, br205 y loopback (lo). Compruebo que el servicio `systemd-resolved` sigue escuchando en `127.0.0.53:53` por lo que no hay ningún conflicto entre ellos.

```bash
# netstat -tulpn |grep 53
[root]@cortafuegix:~#  netstat -tulpn | grep 53
tcp        0      0 127.0.0.1:53            0.0.0.0:*               LISTEN      41744/dnsmasq
tcp        0      0 192.168.100.1:53        0.0.0.0:*               LISTEN      41744/dnsmasq
udp        0      0 127.0.0.1:53            0.0.0.0:*                           41744/dnsmasq
udp        0      0 192.168.100.1:53        0.0.0.0:*                           41744/dnsmasq
```

Verificao que las consultas se las hace a si mismo:

```bash
[root]@cortafuegix:/etc/dnsmasq.d# resolvectl
Global
         Protocols: -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported
  resolv.conf mode: foreign
Current DNS Server: 127.0.0.1
       DNS Servers: 127.0.0.1
        DNS Domain: parchis.org
:
```

Si cortafuegix intenta resolver, se preguntará a si mismo que irá al `server=192.168.100.224` definido en `/etc/dnsmasq.d/000.dnsmasq.conf`, por lo que todo seguirá funcionando.

```bash
$ nslookup ibm.com
Server:         127.0.0.1
Address:        127.0.0.1#53

Non-authoritative answer:
Name:   ibm.com
Address: 23.217.255.169
Name:   ibm.com
Address: 2a02:26f0:b80:693::3831
Name:   ibm.com
Address: 2a02:26f0:b80:686::3831
```

Compruebo desde un ordenador de la red que la resolución es correcta.

```PS1
luis@kymeraw:~ ❯ nslookup.exe asterix.parchis.org
Server:  cortafuegix.parchis.org
Address:  192.168.100.1

Name:    asterix.parchis.org
Address:  192.168.100.12
```

## Rotación del log

El log de `dnsmasq`, configurado en `/var/log/dnsmasq.log`), es extremadamente útil, pero por desgracia no ofrece forma de administrarlos, no los va rotando, así que crecería de forma infinita. Hay un paquete, `dnsmasq-logrotate` que garantizará que los registros se creen y luego se gestionen mediante `logrotate`.

Intalo el paquete [dnsmasq-logrotate](https://github.com/m-grant-prg/dnsmasq-logrotate/wiki) en Ubuntu.

```bash
add-apt-repository ppa:m-grant-prg/utils
apt update
apt-get install dnsmasq-logrotate
```

## Comandos útiles

He dejado `log-queries` en el fichero `/etc/dnsmasq.d/000.dnsmasq.conf`, que es muy útil cuando quieres hacer debug de las consultas DNS. Opcionalmente puedes añadir `log-dhcp` para tener mucha más informacion sobre el servicio de DHCP. Los dos comandos que más utilizo cuando estoy haciendo troubleshooting son:

Para ver si llega una consulta DNS

```bash
sudo tail -n 1000 -f /var/log/dnsmasq.log | grep -i query
```

Para ver si está entregando vía DHCP

```bash
sudo tail -n 1000 -f /var/log/dnsmasq.log | grep -i dhcp
```

El programa `dnsmasq` mantiene una cache en memoria y es posible pedirle al proceso que haga un volcado de la misma en el fichero de log, basta con mandarle la señal USR1. En una sesion puedes estar observando el log y en otra envías la señal.

```bash
proceso=$(ps --no-headers -C dnsmasq -o pid | sed 's/ //g') && kill -s SIGUSR1 $proceso

# otra forma es usar la herramienta que instalé para hacer logrotate
dnsmasq-postrotate -l -v -p
```

Otros comandos curiosos, puede consultarse la cache a través de peticiones dns de clase CHAOS.

```bash
[root]@cortafuegix:~#    dig +short chaos txt cachesize.bind @127.0.0.1
"10000"
[root]@cortafuegix:~#    dig +short chaos txt hits.bind @127.0.0.1
"6621"
[root]@cortafuegix:~#    dig +short chaos txt misses.bind @127.0.0.1
"4472"
```
