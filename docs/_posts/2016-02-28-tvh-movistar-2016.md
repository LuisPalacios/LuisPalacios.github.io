---
title: "Tvheadend y TV (2016)"
date: "2016-02-28"
categories: tv
tags: linux nuc
excerpt_separator: <!--more-->
---

![logo Tvheadend](/assets/img/posts/logo-tvh2016.svg){: width="150px" height="150px" style="float:left; padding-right:25px" } 

Este apunte lo publiqu√© en Wordpress en febrero de 2016 as√≠ que, aunque obsoleto, tienes una referencia sobre c√≥mo instalar Tvheadend en un servidor Linux para ver canales IPTV v√≠a mi contrato Movistar Fusi√≥n TV. Us√© Tvheadend 4.1-1566 y un nuevo m√©todo de descarga del EPG. 

<br clear="left"/>
<!--more-->

Tambi√©n tienes otra versi√≥n de un a√±o antes ([versi√≥n del 2015]({% post_url 2015-01-31-tvh-movistar-2015 %})) pero como hab√≠an cambiado algunas cosas las he documentado. Recuerda que uso un [router Linux]({% post_url 2014-10-05-router-linux %}) y *Kodi en Raspberry Pi* en vez del Router + Deco de Movistar. 

<br/>

## Tvheadend como agregador 

Tvheadend es un fant√°stico agregador de fuentes de video (Sat√©lite, Tdt, IPTV). Aqu√≠ me concentro en usarlo exclusivamente como agregador de canales de Movistar TV.

{% include showImagen.html
    src="/assets/img/posts/fuentesstb2016.png"
    caption="fuentesstb2016"
    width="600px"
    %}

Veremos c√≥mo configurar todos los canales, el EPG, los logos, etc. Te recomiendo encarecidamente que si no tienes experiencia con Tvheadend empieces por configurar solo un √∫nico canal, para conocer su comportamiento en profundidad. 

Si no te funciona algo, vuelve a empezar desde cero (Mira c√≥mo limpiar la configuraci√≥n al final en *trucos de mantenimiento*), configura solo un √∫nico canal, ten siempre un terminal mirando el LOG del programa. Importante no correr, verifica que funciona, que recibes el logo, que se asocia el EPG, en definitiva que aprendas a conocer c√≥mo reacciona el programa ya que algunas cosas no se ejecutan de manera instant√°nea y pueden despistar. 

<br/>

### Instalaci√≥n Tvheadend

Este proceso de instalaci√≥n est√° basado en **Gentoo**, si tienes otra Distro cambiar√°n algo los comandos y directorios, pero ser√° muy parecido. Ojo que uso una versi√≥n descargada directamente de GitHub, por lo tanto:

* Tiene riesgo 
* Si est√°s usando otra versi√≥n m√°s antigua es muy probable que muchas cosas no te funcionen. 
  
He decidido probar la versi√≥n 4.1 porque trae cosas chulas (como importar/vincularse a un fichero M3U con los canales), pero recuerda... tiene el riesgo de reventar cada dos por tres :-)

Despu√©s del aviso: ¬øc√≥mo de inestable es? pues es bastante estable, de vez en cuando (cada 4-5 d√≠as) de repente se queda colgado. Lo que he hecho es programar en el cron que **rearranque el servicio cada d√≠a** y ya est√° (ver c√≥mo al final del apunte). Dicho esto, procedo a instalar el software:

```console
tv # cat /etc/portage/package.accept_keywords
# tvheadend
~media-tv/tvheadend-9999 **       <=== Esto es lo que hace que se baje lo "√∫ltimo" desde github
media-libs/libhdhomerun ~amd64

tv ~ # cat /etc/portage/package.use/tvheadend
media-tv/tvheadend avahi capmt constcw cwc dbus dvb dvbscan ffmpeg hdhomerun imagecache inotify iptv -libav satip timeshift uriparser xmltv zlib

tv ~ # emerge -v libhdhomerun
tv ~ # ln -s /usr/include/hdhomerun/ /usr/include/libhdhomerun

tv ~ # emerge -v tvheadend
:
```

M√°s avisos: Compilar una versi√≥n *en desarrollo* (-9999 *) puede traerte dolores de cabeza. En mi caso utilizo Gentoo y versiones de FFMPEG que est√°n "Hard Masked", es decir, estoy al filo del precipicio.

<br/>

#### Otras distribuciones

Si trabajas con otra distribuci√≥n no deber√≠as tener ning√∫n problema, solo aseg√∫rate de que si cambias de versi√≥n de Tvheadend puede que cambien las opciones. Aseg√∫rate de temas de permisos, usuario/grupo, opciones de compilaci√≥n, librer√≠as, etc. Temas est√°ndar sobre paquetes de software en Linux que no cubro en este documento.

<br/>

### Fichero systemd

Fichero `/etc/systemd/system/tvheadend.service` necesario para ejecutar Tvheadend. 

```config
[Unit]
Description=Tvheadend TV Aggregator
After=network-online.target igmpproxy.service

[Service]
Type=forking
EnvironmentFile=/etc/conf.d/tvheadend
ExecStart=/usr/bin/tvheadend -f -C -u $TVHEADEND_USER -g $TVHEADEND_GROUP -c $TVHEADEND_CONFIG $TVHEADEND_OPTIONS
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

En este caso se utiliza el fichero de configuraci√≥n `/etc/conf.d/tvheadend` para definir las variables que se utilizan en los argumentos de arranque. La m√°s importante es el directorio de trabajo (`TVHEADEND_CONFIG`). Indica d√≥nde bucear cuando quieras ver toda la configuraci√≥n de tvheadend. Ojo que usuario y grupo con el que se ejecutar√° el programa tambi√©n son importantes :-)

* `/etc/conf.d/tvheadend`

```config
# See the tvheadend(1) manpage for more info.

# Run Tvheadend as this user.
TVHEADEND_USER="tvheadend"

# Run Tvheadend as this group.
TVHEADEND_GROUP="video"

# Path to Tvheadend config.
TVHEADEND_CONFIG="/etc/tvheadend"

# Other options you want to pass to Tvheadend.
TVHEADEND_OPTIONS=""
```

<br/>

### Ejecutar Tvheadend

Antes de arrancarlo, te recomiendo que observes en otro terminal la salida del LOG, es muy instructivo.

```console
tv ~ # journalctl -f    ((Ejecutarlo en otra sesi√≥n en otro terminal))
```

Habilito el servicio (para futuros boots) y lo arranco manualmente. La primera vez se crea una estructura de directorios nueva bajo el directorio del programa `/etc/tvheadend` (recuerda la variable `TVHEADEND_CONFIG` que vimos antes).

```console
tv ~ # systemctl enable tvheadend
tv ~ # systemctl start tvheadend
:
tv ~ # cd /etc/tvheadend
tv tvheadend # ls -al
total 40
drwx------ 7 tvheadend video 4096 feb 27 09:11 .
drwxr-xr-x 77 root      root  4096 feb 27 09:02 ..
drwx------ 2 tvheadend video 4096 feb 27 09:11 accesscontrol
drwx------ 2 tvheadend video 4096 feb 27 09:11 bouquet
-rw------- 1 tvheadend video  866 feb 27 09:11 config
drwx------ 3 tvheadend video 4096 feb 27 09:11 dvr
-rw-r--r-- 1 tvheadend video   22 feb 27 09:11 .lock
drwx------ 2 tvheadend video 4096 feb 27 09:11 profile
```

<br/>

### Preparar Logos, fichero M3U y EPG

Antes de arrancar Tvheadend y configurarlo vamos a preparar tres cosas: los logos (picons) de los canales, el fichero M3U que importar√© (y quedar√° vinculado) y los scripts que necesito para descargar y preparar el EPG. Por cierto, he dejado copia de todo esto en [este repositorio en GitHub](https://github.com/LuisPalacios/tvheadend_movistar).


Los tres est√°n vinculados entre s√≠, el nombre de los canales, el nombre de los ficheros, el identificativo del EPG. F√≠jate bien en las descripciones que hago en estos apuntes, si te despistas puede que haya cosas que no te funcionen.

<br/>

#### Directorio picons (para los Logos)

Hay varias formas de enfrentarse al dilema de los logos de los programas de TV, en mi caso me he decantado por uno bastate sencillo, consiste en dedicar un directorio local en el mismo ordenador donde ejecuto Tvheadend: **/etc/tvheadend/picons** y copiar ah√≠ los ficheros. Es un directorio adicional que creo dentro del de configuraci√≥n del programa por comodidad y tenerlo todo junto (puedes utilizar otro cualquiera).

El nombre del fichero jpg o png es **IMPORTANTE** porque si lo nombras de acuerdo a lo que espera Tvheadend te ahorras un mont√≥n de trabajo, as√≠ que te recomiendo que **hagas** **coincidir el nombre del fichero** **con** el **nombre del Canal**, y tenemos dos opciones:

- `Nombre del canal.png`
- `nombredelcanal.png`¬†¬† <== Esta es la opci√≥n que utilizo yo.

_**En mi caso utilizo la segunda opci√≥n**_: hago que **el nombre de los ficheros con los logos de los programas sea igual al nombre del programa que se encontrar√° en el M3U pero: sin espacios, en min√∫sculas y terminado en .png**. Un ejemplo, si el programa se llama "National Geographic HD", el nombre de su fichero con su Logo debe ser "/etc/tvheadend/picons/nationalgeographichd.png".

Creo el directorio, lo asigno los permisos adecuados y me bajo los logos.

```console
tv tvheadend # mkdir /etc/tvheadend/picons
tv tvheadend # chown tvheadend:video /etc/tvheadend/picons
tv tvheadend # cd /etc/tvheadend/picons
tv picons # wget https://raw.githubusercontent.com/LuisPalacios/tvheadend_movistar/master/2016/picons.tgz
tv picons # tar xvfz picons.tgz
tv picons # chown tvheadend:video *
tv picons # ls -al
total 3000
drwx------ 2 tvheadend video    4096 feb 28 10:58 .
drwx------ 13 tvheadend video    4096 feb 27 20:44 ..
-rw-r--r-- 1 tvheadend video    3106 feb 27 21:01 0-fondo.png
-rw-r--r-- 1 tvheadend video   24054 feb 27 21:01 0hd.png
     :                                             :
```

<br/>

#### Fichero M3U

Para poder crear los canales en Tvheadend tienes de nuevo m√∫ltiples mecanismos. Opto por un sistema automatizado, aprovechando una funcionalidad que se soporta en la versi√≥n 4.1. Consiste en **auto-importar** los canales que est√° definidos dentro de un fichero `.m3u`.

El proceso es sencillo y m√°s adelante en la secci√≥n *Configuraci√≥n de Tvheadend* lo describo, no lo hagas ahora pero te adelanto c√≥mo se hace: Creas una `NETWORK` de tipo `IPTV AUTOMATIC NETWORK`, vinculada a un fichero M3U del disco duro y si construyes de forma adecuada el fichero .m3u puedes ahorrarte muchas horas de trabajo.

Aqu√≠ tienes una [copia de mi fichero tv.m3u](https://raw.githubusercontent.com/LuisPalacios/tvheadend_movistar/master/2016/tv.m3u), est√° preparado para mi demarcaci√≥n (ver√°s que tengo configurado Telemadrid porque estoy en Madrid), est√° dise√±ado para mi *setup* donde empleo http (mira la secci√≥n [udpxy]({% post_url 2014-10-05-router-linux %}) de este apunte) y por supuesto tiene mis canales contratados.

|¬†Importante: si te bajas el fichero anterior ver√°s que tiene la **numeraci√≥n de los canales** que emplea oficialmente Movistar TV. Una de las ventajas de Tvheadend es que puedes hacer lo que quieras con la numeraci√≥n de los canales y para evitar tener que asignar uno a uno el n√∫mero apropiado, lo que hago es a√±adir (en la l√≠nea EXTINF) el n√∫mero final que quiero que tenga cada canal. |

Probablemente tengas que bajarte el fichero y editarlo para adecuarlo a tu caso (las MRL‚Äôs son distintas si usas multicast o si tienes otros canales contratados u otra demarcaci√≥n). En mi caso no mantengo actualizado el fichero en el enlace anterior, si quieres una versi√≥n actualizada de la lista de canales de Movistar, te recomiendo la ya famosa ¬´[LISTA ACTUALIZADA DE CANALES PARA VLC](https://www.adslzone.net/foro/movistar-tv-imagenio.38/lista-actualizada-canales-vlc.350532/)¬ª disponible en **ADSL ZONE**. Lo dicho, ad√°ptalo a tu instalaci√≥n. Dejo una l√≠nea comentada a continuaci√≥n para explicar qu√© significa cada cosa:


```config
:
#EXTINF:-1 tvh-epg="disable" tvh-chnum="1" tvh-tags="tv|Ocio y cultura",La 1 HD
http://192.168.1.1:4022/udp/239.0.0.185:8208
:

1) #EXTINF:-1 tvh-epg="disable" tvh-chnum="1" tvh-tags="tv|Ocio y cultura",La 1 HD
              |                  |             |                            |
              |                  |             |                            +--> Nombre canal
              |                  |             +---> Tags
              |                  +---> N√∫mero de canal 
              +---> EPG scan
```

* Nombre del canal: Importante que coincida con el usado en el EPG
* Tags: Etiquetas que quieres asignarle al cana, en el ejemplo defino un par. 
* N√∫mero de canal: que quiero que se asigne al hacer el MAPPING m√°s adelante.
* tvh-epg: Deshabilito el "EPG scan" en el MUX. No lo usar√© porque proveo el EPG mediante otro mecanismo. 

```config
:
1) http://192.168.1.1:4022/udp/239.0.0.185:8208
Como dec√≠a, en mi caso utilizo HTTP porque empleo "udpxy". 
```

```console
tv ~ # chown tvheadend:video /etc/tvheadend/tv.m3u
```

**Otro avisos**. Si te fijas he puesto que el *Nombre del canal: Importante que coincida con el usado en el EPG*, pues eso, tenlo en cuenta porque es important√≠simo. Si usas mi fichero no deber√≠as tener problema, pero si haces el M3U t√∫ mismo, acu√©rdate de este detalle.

<br/>

#### EPG Grabber

Siempre he creido que el mejor m√©todo para bajarme el EPG ser√≠a el que corresponde con mi contrato, pedirlo por la VLAN2 directamente a Movistar TV utilizando su API, pero por desgracia no lo tienen documentado, as√≠ que... hay varias alternativas: 

* Usar el API a trav√©s de la VLAN2. Como dec√≠a, no hay documentaci√≥n
* Proyecto [movistartv2xmltv]({% post_url 2015-01-31-tvh-movistar-2015 %}) (que por desgracia ya no funciona)
* Bajarse el XMLTV desde alg√∫n sitio (funciona).
* Exportar desde web de Movistar TV (funciona, *descubierto* en 2017).
* Usar t√©cnicas complejas como [WebGrab+Plus]({% post_url 2015-02-03-webgrabplus %}) (en mi caso lo uso para complementar)

Hago menci√≥n aqu√≠ a un trabajo muy interesante, el [Add-on para KODI](https://sourceforge.net/projects/movistartv/)) pero por desgracia el autor no ha liberado los fuentes a la fecha de escribir este apunte.

<br/>

#### Opciones:

Aqu√≠ tienes las dos opciones que he utilizado en mi caso:

* (2016) Empec√© con los Ficheros pre-creados: La soluci√≥n que he estado utilizando durante el 2016 consiste en bajarse directamente el fichero XMLTV dirariamente desde alg√∫n sitio donde ¬´alguien¬ª sea tan generoso como para dejarlo. Hasta Julio/2016 utilizaba este [proyecto que descarga el fichero desde rytec en la comunidad vuplus](http://www.iptvsaga.com/xmltv-epg-graber-batch-script-for-windows/), a partir de esa fecha dej√≥ de funcionar y he pasado, gracias **Josu** (comentarios en el blog antiguo), a usar esta [fuente desde tododream](http://epg.tododream.com/latinmunich_xmltv-movistar-spain.gz) que viene de este [apunte hecho por el usuario latinmunic](http://www.tododream.com/foro/e2-plugins/177073-nuevo-epg-movistar-enigma2-crossepg.html) en el foro de tododream.
* (2017) Descargo desde la Web Movistar TV: Novedad en el 2017, gracias a **Neoshinji** ( comentarios en el blog antiguo), comparti√≥ un m√©todo muy interesante, aprovechando que Movistar TV permite exportar la programaci√≥n desde su p√°gina web y adem√°s lo complemento con [WebGrab+Plus]({% post_url 2015-02-03-webgrabplus %}) para completar los canales que me faltan.

<br/>

#### Ficheros pre-creados

Creo una [serie de scripts](https://github.com/LuisPalacios/tvheadend_movistar) que se encargan de descargar el EPG directamente a un fichero XMLTV. El script principal se llama [descarga_guia.sh](https://github.com/LuisPalacios/tvheadend_movistar/blob/master/2016/descarga_guia.sh), ejecuta la descarga y el renombrado de canales coincidan con los nombres de canal que doy de alta en Tvheadend. Los he creado/instalado en un usuario normal donde adem√°s configuro el cron para que se ejecute una vez al d√≠a, a las 07:00 am (es m√°s que suficiente).

```console
luis@tv ~ $ crontab -e     ((( A√±ade la l√≠nea siguiente))) 
0 7 * * * /home/luis/guia/descarga_guia.sh

:

luis@tv ~ $ crontab -l
0 7 * * * /home/luis/guia/descarga_guia.sh
```

Una vez que tengo todo preparado ejecuto el script manualmente para que haga una primera descarga del fichero `guia.xml`. Quiero tenerla antes de a√±adir los canales..

```console
luis@tv ~ $ /home/luis/guia/descarga_guia.sh
```

Despu√©s de ejecutarlo deber√≠as tener el fichero `/tu/directorio/destino/guia.xml` perfectamente creado y con contenido.

NOTA: Recuerda, hasta Julio/2016 estaba usando el script [descarga_guia_vuplus.sh](https://github.com/LuisPalacios/tvheadend_movistar/blob/master/2016/descarga_guia_vuplus.sh) pero dej√≥ de funcionar. He creado una versi√≥n llamada de[scarga_guia_tododream.sh](https://github.com/LuisPalacios/tvheadend_movistar/blob/master/2016/descarga_guia_tododream.sh) gracias a un enlace que nos ha pasado **Josu** (comentarios en el blog antiguo).

<br/>

#### Descarga web Movistar TV (2017)

Esto es nuevo en el 2017, gracias a **Neoshinji** (comentarios en el blog antiguo) nos ha dado una pista muy buena sobre un m√©todo que desconoc√≠a.

Movistar TV tiene una p√°gina desde la cual se puede [EXPORTAR LA PROGRAMACI√ìN](http://comunicacion.movistarplus.es/guiaProgramacion/exportarProgramacion), si conectas ver√°s que puedes seleccionar qu√© cadenas y formato (xml, csv, excel, texto) prefieres. Mirando en m√°s detalle vemos que se trata de un programa en Javascript y dicho programa, una vez eliges lo que quieres, realizar√° un POST parametrizado a dicha web para solicitar la exportaci√≥n.

Despu√©s de un par de d√≠as investigando he creado un programa en Javascript para **node.js** que voy a ejecutar peri√≥dicamente en mi mismo servidor linux donde ejecuto Tvheadend:

* Proyecto [tvhstar en GitHub](https://github.com/LuisPalacios/tvhstar)

El objetivo era que crease el fichero epg en formato XMLTV:¬†**guia.xml**, ¬†pero ya puestos¬†le he ido a√±adiendo m√°s cosas:

- Descarga peri√≥dica de la programaci√≥n de TV (EPG) desde la web de Movistar y creaci√≥n de un fichero XMLTV compatible con Tvheadend
- Creaci√≥n de los ficheros tvHOME.m3u y tvREMOTE.m3u para ser consumidos por Tvheadend como fuentes para redes IPTV din√°micas
- Logos de los programas de TV en formato 800x400 para ser consumidos por Tvheadend (y sus clientes).

<br/>

#### Completo canales que faltan con WebGrab+Plus¬†(2017)

Una vez que tengo el fichero XMLTV usando el proyecto anterior estoy completando algunos canales que me faltan (como por ejemplo Telemadrid) apoy√°ndome en WebGrab+Plus. Estos scripts crean un fichero adicional XMLTV (guia-wg.xml).

* Proyecto [tvhwg en GitHub](https://github.com/LuisPalacios/tvhwg)

<br/>

#### Configurar Tvheadend para "leer" los¬†ficheros XMLTV

Lo que describo a continuaci√≥n se debe hacer para cada fichero XMLTV que tengas. En este ejemplo ver√°s que hablo del guia.xml que genera mi proyecto "tvhstar", pero tendr√°s que hacer lo mismo con el fichero `guia-wg.xml`. Una vez tenemos el fichero `/tu/directorio/destino/guia.xml` configura Tvheadend para que lo "consuma" y lo guarde en su propio formato en su propio directorio.

Tvheadend se va a **apropiar**, a trav√©s de un "Grabber **interno**", de la programaci√≥n. En nuestro caso, que ya tenemos el fichero en el formato final (XMLTV), lo √∫nico ¬†que hacemos es crear dicho grabber como un ejecutable que simplemente hace un `cat` del fichero. Cuando Tvheadend lo reciba lo¬†transformar√° a su propio formato en el fichero `/etc/tvheadend/epgdb.v2`.

Creo el fichero /usr/bin/tv_grab_movistartv. Recuerda cambiar sus permisos a ejecutable y la pr√≥xima vez que ejecutes tvheadend lo descubrir√° autom√°ticamente (tvheadend encuentra todos los ficheros que empiezan por /usr/bin/tv_grab* durante su arranque).

No te olvides de cambiar la l√≠nea donde pone `xmltv_file_location` por el path completo al fichero final XMLTV que quieres que procese (en este primer ejemplo `guia.xml`).

{% gist b6242399229b87d86d28f9db540f66bd %}

**IMPORTANTE:** Si tienes m√°s ficheros XMLTV pues creas otro fichero, por ejemplo `/usr/bin/tv_grab_w` (para el que hice con mi complemento de WebGrab+Plus).

Ahora que tenemos ya una idea de los ficheros entremos en harina y empecemos a configurar Tvheadend. Hasta ahora lo √∫nico que hemos hecho antes de arrancar Tvheadend y configurarlo es preparar tres cosas: los logos (picons) de los canales, el fichero M3U que importar√© (y quedar√° vinculado) y los scripts que necesito para descargar y preparar el EPG.

<br/>

## Configuraci√≥n de Tvheadend

A partir de aqu√≠ configuramos desde el interfaz Web. Arranco Tvheadend y desde un navegador conectamos con el Administrador Web de Tvheadend: **http://tu-servidor.dominio.com:9981**.

```console
tv # systemctl start tvheadend
```

<br/>

#### Configuraci√≥n general

Ver√°s como autom√°ticamente arranca el asistente para realizar una configuraci√≥n guiada. Yo **prefiero cancelarlo** y hacer una configuraci√≥n manual. Lo primero que hago es cambiar par√°metros de la configuraci√≥n general: `Configuraci√≥n > General > Base`

{% include showImagen.html
    src="/assets/img/posts/ng-tvh-0-1024x755.png"
    caption="Plataforma Tvheadend"
    width="600px"
    %}

- **User interface level: Expert**
- **Default Languages Selected: **Spanish y English****
- **Channel Icon Path: _file:///etc/tvheadend/picons/%c.png¬† (%C.png)_**
- **Channel Icon Name Scheme: Service name picons**

El par√°metro `Channel Icon Path` sirve para decirle a Tvheadend: Busca los logos de los programas en el directorio `/etc/tvheadend` y que tengan como nombre del fichero el nombre del programa, sin espacios, sin s√≠mbolos raros, todo en min√∫sculas. Puedes usar `%c` o `%C` (apropiada para canales con caracteres diacr√≠ticos, he empezado a usarla recientemente). La opci√≥n "Service name picons" es la que elimina los espacios en el nombre.

{% include showImagen.html
    src="/assets/img/posts/ng-tvh-10.png"
    caption="Configuraci√≥n general"
    width="600px"
    %}

Este path al icono del canal lo ver√°s m√°s adelante en la opci√≥n **User Icon** en `Configuraci√≥n > Channel/EPG > Channels`. Ver√°s c√≥mo Tvheadend *rellena* dicho campo con lo mismo que pone en Channel Icon Path pero obviamente sustituyendo `%c` o `%C` por el nombre del canal. Lo que quiero anticiparte es que siempre podr√°s volver aqu√≠ a cambiar "Channel Icon path / Channel icon name scheme" y desde `Configuraci√≥n > Channel/EPG > Channels` podr√°s pedir que se regeneren todos los User Icon's con el cambio que hagas aqu√≠.

#### Configuro el EPG Grabber

Necesitas tener un fichero en formato XMLTV (ya vimos antes las opciones), en micaso lo llam√© `guia.xml`. Necesitas adem√°s un script tv_grab* que simplemente usar√° Tvheadend para *leer* dicha `guia.xml`. En mi ejemplo el script `/usr/bin/tv_grab_movistartv` buscar√° fichero `/tu/directorio/guia.xml` y le har√° un simple cat. Tvheadend absorver√° esos datos, los interpretar√°, buscar√° qu√© canales tiene ya configurados con esos nombres y si hay coincidencias las utilizar√°. Ah!, y lo salvar√° todo dentro de un fichero llamado `/etc/tvheadend/epgdb.v2 `([por cierto, aqu√≠ tienes m√°s informaci√≥n sobre el Epgdb](https://tvheadend.org/projects/tvheadend/wiki/Epgdb)).

Nota: Si tienes m√°s de un fichero XMLTV simplemente repite exactamente lo mismo y crea un segundo grabber interno, de hecho es lo que yo hago para a√±adir el que genero con WebGrab+Plus.

Por lo tanto, lo que vamos a hacer es configurar Tvheadend para indicarle que a partir de ahora debe hacer *EPG Grabbing*. Entra en `Configuration->Channel/EPG->EPG Grabber Modules`. Deber√≠as ver el grabber de movistar (tvheadend escanea el directorio `/usr/bin` en busca de ficheros que empiezan por tv_grab*). √Åctivalo (enable) y desactiva el resto (disable). Ojo!, en cuanto le das al bot√≥n del Save ver√°s en el log (`journalctl -f`) c√≥mo hace el parse del EPG.

{% include showImagen.html
    src="/assets/img/posts/tvhgrabbers2-1024x452.png"
    caption=""
    width="600px"
    %}

Configura la periodicidad en la que Tvheadend ejecuta el grabber. ¬øQu√© es esto?, simplemente est√°s diciendole a Tvheadend cada cuanto tiempo debe ejecutar el programa `/usr/bin/tv_grab*`. Observa que usa el mismo formato que crontab. En mi caso recordar√°s que tengo un script que se va a internet a bajarse el EPG, as√≠ que configuro el *grabber* de Tvheadend para que lo leo aproximadamente media hora despu√©s.

{% include showImagen.html
    src="/assets/img/posts/ng-tvh-13.png"
    caption="ng-tvh-13"
    width="600px"
    %}

Vale, ya tenemos *programado y configurado* el EPG Grabber, pero obviamente no funciona nada todav√≠a, porque hay que crear las fuentes de los canales, los propios canales, asociarlos al EPG. Nota: *el orden NO es importante*, yo estoy siguiendo un orden que te *ahorrar√° tiempo*, simplemente.

<br/>

#### A√±ado una red nueva IPTV

A√±ado una red nueva de tipo **IPTV Autom√°tica** (significa que va a importar desde un M3U): Configuraci√≥n->DBV Inpurts->Network.

- **Network name**: iptv
- **Maximum # of input streams**: 3 (Al terminar lo volveremos a dejar a 0)
- **URL**: `file:///etc/tvheadend/tv.m3u`
- **Maximum timeout (seconds)**: 2 (incluso 1, al terminar lo volveremos a dejar en 15)
- **Idle Scan Muxes**: (x) marcado (Al terminar lo desmarcaremos)
- **EIT time offset**: Local server time
- **Re-fetch period (mins)**: 60 (no lo cambio, pero podr√≠as poner un 1)

{% include showImagen.html
    src="/assets/img/posts/ng-tvh-11.png"
    caption="A√±adimos una nueva red IPTV"
    width="600px"
    %}

En cuanto le das al bot√≥n "create" lo que ocurre es lo siguiente. Tvheadend analiza el fichero M3U, importa cada una de las l√≠neas en MUXES. Gracias a tener "input streams: 3" y "idle scan muxes: activo" estamos pidiendo que se quede analizando de forma continua los muxes, que lo haga de tres en tres, compruebe si funcionan y si es as√≠ los "a√±ada" como SERVICEs. En mi caso, mi fichero m3u, tengo 108 l√≠neas que se esca   nean de 3 en 3, por lo tanto tarda unos cuantos minutos en terminar. Termina cuando tienes el mismo n√∫mero de SERVICES que MUXES.

Nota sobre el par√°metro "Re-fetch period". Indica cada cuanto tiempo debe releer el fichero M3U para configurar los cambios que detecte. Muy interesante ponerlo a '1min' si est√°s haciendo pruebas.

{% include showImagen.html
    src="/assets/img/posts/tvh-14.png"
    caption="Muxes"
    width="600px"
    %}

{% include showImagen.html
    src="/assets/img/posts/tvh-15.png"
    caption="Servicios"
    width="600px"
    %}

Una vez que termina (el n√∫mero de MUXES==n√∫mero de SERVICES) ya puedes cambiar la configuraci√≥n del NETWORK, es decir volver a dejar en sus valors de por defecto par√°metros como input streams, idle scan muxes, maximum timeout, etc.

- Maximum timeout (seconds): 15
- Maximum # of input streams: 0
- Idle Scan Muxes: ( )
- Re-fetch period: 60

El siguiente paso consiste en crear los canales. Entra en SERVICES y haz click en `Map All Services`

{% include showImagen.html
    src="/assets/img/posts/ng-tvh-16.png"
    caption="Map All Services"
    width="600px"
    %}

Ve a CHANNELS, ver√°s que tienen asignado el logo adecuado (seg√∫n el nombre del canal, en min√∫sculas y sin espacios...); **pero nos falta el EPG**

{% include showImagen.html
    src="/assets/img/posts/ng-tvh-17.png"
    caption="Asignado el Logo"
    width="600px"
    %}

Podemos hacer un truco para que nos "autocomplete" el nombre del EPG. Si te fijas en los canales todos tienen la opci√≥n "Automatically Map EPG Source" as√≠ que: 1) abajo a la derecha donde pone "per page" pon "all", 2) selecciona TODOS los canales, 3) haz click en Edit, deshabilitalos, 4) Apply, 5) sin salir habilitalos de nuevo, 6) Apply, Boom!! ver√°s c√≥mo autom√°ticamente todos los canales cuyo nombre sea el mismo que el del EPG se auto-asociar√°n. Esto te evitar√° mucho trabajo, algunos quedar√°n pendientes de asociar, pero ser√°n muy pocos, as√≠ que haz t√∫ la asociaci√≥n manualmente (no te olvides !!!!).

{% include showImagen.html
    src="/assets/img/posts/tvh-18.png"
    caption="Autocompletado"
    width="600px"
    %}

<br/>

#### ¬øqu√© pasa con el EPG?

Llegados a este punto ya has terminado y puedes disfrutar de esta nueva versi√≥n de Tvheadend 4.1. Puede que todav√≠a no veas el `EPG`, el motivo es que Tvheadend se puede tomar con mucha calma este tema, es decir, puedes tener todo perfectamente configurado pero hasta que le toque un ciclo de lectura, asociaci√≥n y activaci√≥n del EPG no lo ver√°s. Mira la secci√≥n de Trucos de mantenimiento donde creo que puedes encontrar consejos √∫tiles.

Si est√°s trasteando con el EPG y no te funciona: 1) Para tvheadend. 2) Borra el fichero `/etc/tvheadend/epgdb.v2`. 3) Arranca el log en otro terminal y 4) arranca de nuevo Tvheadend, ver√°s que se recrea el `epgdb.v2`.

```console
tv ~ # cd /etc/tvheadend/
tv tvheadend # ls -al epgdb.v2
-rw------- 1 tvheadend video 3031661 mar 25 19:24 epgdb.v2
tv tvheadend # rm epgdb.v2
tv tvheadend # systemctl stop tvheadend

(( Recomendado mirar el Log (ejecutar en otro terminal) ))
tv # journalctl -f -u tvheadend

(( Rearranco: El fichero epgdb se recrea de nuevo al cabo de un rato ))
tv tvheadend # systemctl start tvheadend
```

<br/>

#### ¬øre-nombrar los picons?

No necesitas hacer nada si has seguido las instrucciones hasta aqu√≠. En esta secci√≥n describo un truco interesante si quieres utilizar una nomenclatura distinta para el nombre de los picons, puedes pedirle a Tvheadend que renombre el campo "User icon" de *todos* los canales a la vez.

Si cambias los par√°metros `Channel icon path y/o Channel icon name scheme` en `Configuration > General > Base`, sigue los siguientes pasos para re-crear el nombre del canal en el campo User icon de *todos* los canales: Ve a `Configuration > Channel/EPG > Channels` 1) abajo a la derecha donde pone `per page` pon `all`, 2) selecciona TODOS los canales, 3) haz click en `Reset icons` (se borrar√° User icon en todos), 4) pulsa en `Save`, Boom!! ver√°s c√≥mo autom√°ticamente se regenera el nombre de nuevo en todos los canales.

<br/>

## Canales simult√°neos

Men consultaron sobre el n√∫mero m√°ximo de canales simult√°neos soportados. Hac√≠a tiempo que no lo probaba as√≠ que dejo aqu√≠ los resultados de las pruebas. Notar que hago todas las pruebas desde un equipo OSX utilizando m√∫ltiples instancias de VLC. Es mucho m√°s r√°pido (y barato) que poner raspberry's :-).

<br/>

### Prueba 1: m√∫ltiples VLC's usando RTP (Multicast) en directo, sin tvheadend.

Consigo abrir hasta 10 canales HD distintos simult√°neos con VLC (~99.5Mbps). Utilizo URI's que piden los streams en modo RTP (Multicast) de forma directa sin pasar por tvheadend:

```config
#EXTINF:-1,[000] Movistar+ HD
rtp://@239.0.5.185:8208
#EXTINF:-1,[001] La 1 HD
rtp://@239.0.0.185:8208
:
```

Utilizo el siguiente script para lanzar m√∫ltiples instancias de VLC en OSX.

```console
#!/bin/bash
# Script para ver la TV directamente desde VLC
#
open -na /Applications/VLC.app/Contents/MacOS/VLC --args /Users/luis/priv/TV/0-MovistarTV_RTP_HD.m3u --deinterlace-mode=blend --deinterlace=-1
```

En el gr√°fico podemos ver todos los canales reproduciendose simult√°neamente y c√≥mo consume aproximadamente ~99.5Mbps en la vlan2 a trav√©s de mi router (linux). Los VLC's acceden directamente al router, no v√≠a tvheadend.

{% include showImagen.html
    src="/assets/img/posts/9canales.jpg"
    caption="Nueve canales"
    width="600px"
    %}

<br/>

### Prueba 2: tvheadend con canales configurados para usar RTP/Multicast

En esta segunda prueba abro 11 canales HD distintos (11 instancias VLC) simult√°neas (95,3Mbps). En esta ocasi√≥n voy a trav√©s de tvheadend, as√≠ que he a√±adido unos cuantos canales al fichero /etc/tvheadend/tv.m3u usando RTP, le pongo un n√∫mero de canal y un nombre distintos para que me aparezcan y no se confunda con los que ya ten√≠a.

```console
:
#EXTINF:-1 tvh-epg="disable" tvh-chnum="210" tvh-tags="tv|Entretenimiento",RTP Movistar+ HD
rtp://@239.0.5.185:8208
#EXTINF:-1 tvh-epg="disable" tvh-chnum="211" tvh-tags="tv|Entretenimiento",RTP La 1 HD
rtp://@239.0.0.185:8208
:
```

Descargo la nueva lista de canales. Se puede hacer desde tu servidor tvheadend con: `http://tvheadend.server.org:9981/playlist/channels`

```config
:
#EXTINF:-1 logo="http://tvheadend.server.org:9981/imagecache/167" tvg-id="058471559a7ad089c26d395b12345678",Movistar+
http://tvheadend.server.org:9981/stream/channelid/1433502725?ticket=0CCF3D5A07BC3E0F3A5EFE44068502DF12345678&profile=pass
#EXTINF:-1 logo="http://tv.parchis.org:9981/imagecache/207" tvg-id="3d1dd75176c47386c37b50bf12345678",La 1 HD
http://tvheadend.server.org:9981/stream/channelid/1373052221?ticket=FA06FE51437BCBCA504B71D9683D4DAE12345678&profile=pass
:
```

{% include showImagen.html
    src="/assets/img/posts/11canalesHD.jpg"
    caption="Once canales en HD"
    width="600px"
    %}

<br/>

### Prueba 3: tvheadend a trav√©s de udpxy

No consegu√≠a pasar de 3 canales y he descubierto que la raz√≥n no pod√≠a ser m√°s simple, udpxy sirve un m√°ximo de 3 clientes por defecto, y si quieres soportar m√°s solo tienes que usar el argumento ‚Äò-c‚Äô. He corregido mi apunte [Movistar Fusi√≥n Fibra + TV + VoIP con router Linux](% post_url 2014-10-05-router-linux %}) para reflejarlo.

Repito las pruebas desde OSX con VLC, le pido que conecte con el servidor Tvheadend y a este a su vez que vaya a trav√©s de UDPXY.

Fichero M3U usado en el Servidor donde corre tvheadend

```config
:
#EXTINF:-1 tvh-epg="disable" tvh-epg="disable" tvh-chnum="0" tvh-tags="tv|Info",Movistar+
http://192.168.1.1:4022/udp/239.0.5.185:8208
#EXTINF:-1 tvh-epg="disable" tvh-chnum="1" tvh-tags="tv|Ocio y cultura",La 1 HD
http://192.168.1.1:4022/udp/239.0.0.185:8208
:
```

Fichero M3U usado en el OSX con VLC. Este fichero lo puedes descargar desde tu servidor tvheadend con: http://tvheadend.server.org:9981/playlist/channels

```config
:
#EXTINF:-1 logo="http://tvheadend.server.org:9981/imagecache/167" tvg-id="058471559a7ad089c26d395b12345678",Movistar+
http://tvheadend.server.org:9981/stream/channelid/1433502725?ticket=0CCF3D5A07BC3E0F3A5EFE44068502DF12345678&profile=pass
#EXTINF:-1 logo="http://tv.parchis.org:9981/imagecache/207" tvg-id="3d1dd75176c47386c37b50bf12345678",La 1 HD
http://tvheadend.server.org:9981/stream/channelid/1373052221?ticket=FA06FE51437BCBCA504B71D9683D4DAE12345678&profile=pass
:
```

{% include showImagen.html
    src="/assets/img/posts/11canalestcp.jpg"
    caption="Once canales en TCP"
    width="600px"
    %}

<br/>

### Prueba 4: ¬ød√≥nde est√° el l√≠mite? 

¬øn√∫m. de canales o ancho de banda?. Hago una √∫ltima prueba concluyente. Intento abrir el n√∫mero m√°ximo de canales en SD y descubro que **no me deja pasar de 11 canales**, al intentar abrir el duod√©cimo da un error.

{% include showImagen.html
    src="/assets/img/original/11canalesSD.jpg"
    caption="Once canales m√°ximo"
    width="600px"
    %}

### Conclusi√≥n

Seg√∫n las pruebas realizadas (Feb'2016) Movistar TV por fibra (con 300/300 Mbps) soporta hasta 11 Canales o 100Mbps, lo que antes se alcance.

<br/>

## Trucos de mantenimiento

### Forzar la ejecuci√≥n del EPG Grabber

Si no ves el EPG es probablemente por culpa de 1) No has asociado el nombre del EPG que viene del fichero XMLTV a tu canal o 2) No se ha ejecutado el EPG Grabber todav√≠a. De hecho, Tvheadend se puede tomar con mucha calma este tema, es decir, puedes tener todo perfectamente configurado pero hasta que le toque un ciclo de lectura, asociaci√≥n y activaci√≥n del EPG no har√° el grab, es un tema bastante as√≠ncrono.

Para el primer caso (no tienes bien la configuraci√≥n) solo te puedo recomendar repasar todo lo que describo en este apunte. Para el segundo caso (no se ha ejecutado el EPG Grabber), mira a ver si el siguietne truco te sirve:

Una vez que creo tener todo bien configurado fuerzo la ejecuci√≥n del EPG Grabber: Paro Tvheadend, borro el fichero `epgdb.v2`, dejo en otro terminal ir viendo el Log, vuelvo a arrancar Tvheadend y fuerzo un EPG Scan.

```console
tv ~ # systemctl stop tvheadend
tv ~ # cd /etc/tvheadend/
tv tvheadend # rm epgdb.v2
:
tv ~ # systemctl start tvheadend
```

En otro terminal tengo arrancado `journalctl` y observo que efectivamente re-crea todo lo relacionado con EPG pero curiosamente "no" ejecuta el grabber. Lo que dec√≠a, cosas de Tvheadend üòÑ.

```
tv ~ # journalctl -f -u tvheadend
:
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module eit created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module uk_freesat created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module uk_freeview created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module viasat_baltic created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module Bulsatcom_39E created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module psip created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module opentv-skyit created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module opentv-skyuk created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module opentv-ausat created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module opentv-skynz created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module pyepg created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module xmltv created
abr 09 09:07:28 tv tvheadend[23245]: spawn: Executing "/usr/bin/tv_find_grabbers"
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module /usr/bin/tv_grab_combiner created
abr 09 09:07:28 tv tvheadend[23245]: epggrab: module /usr/bin/tv_grab_movistartv created
```

Entro en la configuraci√≥n de Tvheadend y fuerzo un EPG Scan.

{% include showImagen.html
    src="/assets/img/posts/epggrab.png"
    caption="Fuerzo un EPG Scan"
    width="600px"
    %}

```console
tv ~ # journalctl -f -u tvheadend
:
abr 09 09:09:28 tv tvheadend[23245]: /usr/bin/tv_grab_movistartv: grab /usr/bin/tv_grab_movistartv
abr 09 09:09:28 tv tvheadend[23245]: spawn: Executing "/usr/bin/tv_grab_movistartv"
abr 09 09:09:28 tv tvheadend[23245]: /usr/bin/tv_grab_movistartv: grab took 1 seconds
abr 09 09:09:30 tv tvheadend[23245]: /usr/bin/tv_grab_movistartv: parse took 2 seconds
abr 09 09:09:30 tv tvheadend[23245]: /usr/bin/tv_grab_movistartv:   channels   tot=  108 new=    0 mod=    0
abr 09 09:09:30 tv tvheadend[23245]: /usr/bin/tv_grab_movistartv:   brands     tot=    0 new=    0 mod=    0
abr 09 09:09:30 tv tvheadend[23245]: /usr/bin/tv_grab_movistartv:   seasons    tot=    0 new=    0 mod=    0
abr 09 09:09:30 tv tvheadend[23245]: /usr/bin/tv_grab_movistartv:   episodes   tot=24178 new=24178 mod=24178
abr 09 09:09:30 tv tvheadend[23245]: /usr/bin/tv_grab_movistartv:   broadcasts tot=24178 new=23757 mod=23757
```

Por √∫ltimo, √©chale un ojo a la captura siguiente, en esta secci√≥n de la configuraci√≥n deber√≠as ver todas las asociaciones que se han realizado pero es importante que conozca que esta parte NO la he tenido que configurar, sino que autom√°ticamente ha quedado as√≠ configurada por el hecho de seguir todos los pasos que he documentado.

{% include showImagen.html
    src="/assets/img/posts/epggrabberchannels.png"
    caption="Asociaciones"
    width="600px"
    %}

<br/>

### Backup de la configuraci√≥n

En mi caso, que trabajo con versiones "en desarrollo" de Tvheadend, siempre me hago copia del ejecutable y de su configuraci√≥n. Usa el c√≥digo de versi√≥n exacto que est√°s ejecutando para ambos backups, as√≠ puedes dar "marcha atr√°s" de forma sencilla.

```console
tv ~ # /usr/bin/tvheadend --version
/usr/bin/tvheadend: version 4.1-1116~gf51239c-dirty
tv ~ # cp /usr/bin/tvheadend /usr/bin/tvheadend-4.1-1116~gf51239c-dirty

tv ~ # systemctl stop tvheadend
tv ~ # cd /etc/tvheadend/
tv tvheadend # tar cvfz /directorio/destino/del/backup/fecha-tvheadend-4.1-1116~gf51239c-dirty
tv tvheadend # systemctl start tvheadend
```

<br/>

### Restaurar un backup de la configuraci√≥n

**OJO!! que aqu√≠ se usa el comando `rm -fr` y ya sabes lo peligroso que es. Mucho quidadito :-)**. Lo dicho, si quieres recuperar un backup de la configuraci√≥n:

```console
tv ~ # systemctl stop tvheadend
tv ~ # rm -fr /etc/tvheadend/
tv ~ # mkdir /etc/tvheadend
tv ~ # cd /etc/tvheadend/
tv tvheadend # tar xvfz /directorio/destino/del/backup/backup_tvheadend_fecha.tgz tv ~ # systemctl start tvheadend
```

<br/>

### Limpiar la configuraci√≥n

**OJO!! de nuevo, un ejemplo con el comando `rm -fr` y ya sabes lo peligroso que es**. Si en el futuro quieres empezar con una configuraci√≥n completamente limpia o si quieres volver a empezar de cero necesitar√°s hacer lo siguiente (sin tener que reinstalar el software). F√≠jate que salvo los logos de los programas y tambi√©n el fichero M3U temporalmente.

```console
tv ~ # mv /etc/tvheadend/picons /tmp
tv ~ # mv /etc/tvheadend/tv.m3u /tmp
tv ~ # systemctl stop tvheadend
tv ~ # rm -fr /etc/tvheadend
tv ~ # mkdir /etc/tvheadend
tv ~ # mv /tmp/picons /etc/tvheadend
tv ~ # mv /tmp/tv.m3u /etc/tvheadend
tv ~ # cd /etc/tvheadend
tv ~ # chown -R tvheadend:video picons/ tv.m3u
tv ~ # systemctl start tvhe/adend
```

<br/>

### Trabajo con los servicios Systemd

Estos son los comandos m√°s utilizados para habilitar, des-habilitar, arrancar o parar el servicio

```console
tv ~ # systemctl enable tvheadend
tv ~ # systemctl disable tvheadend
tv ~ # systemctl start tvheadend
tv ~ # systemctl stop tvheadend
```

<br/>

### Rearrancar Tvheadend cada cierto tiempo

Lo avisaba al principio del apunte, aqu√≠ describo una versi√≥n *en desarrollo* y acepto que pueda *petar* de vez en cuando. De hecho, cada 4 o 5 d√≠as de repente se queda colgado. Lo que he hecho es programar que el servicio se re-arranque a las 4 de la ma√±ana todos los d√≠as, que no veo la tele :-), lo hago con¬†**systemd**:

- Fichero /etc/systemd/system/tvh-restart.timer

```config
[Unit]
Description=Rearrancar Tvheadend a las 4:00

[Timer]
OnCalendar=*-*-* 04:00:00
Unit=tvh-restart.service

[Install]
WantedBy=timers.target
````

- Fichero /etc/systemd/system/tvh-restart.service

```config
[Unit]
Description=Rearranco Tvheadend

[Service]
Type=oneshot
ExecStart=/usr/bin/systemctl try-restart tvheadend.service
```

- Habilito y arranco el **.timer (no el .service)**.

```console
tv ~ # systemctl enable¬†tvh-restart.timer
tv ~ # systemctl start¬†tvh-restart.timer
```

- Si quieres ver los timers

```console
tv ~ # systemctl list-timers --all
```

- Solo si modificas los ficheros y quieres que interprete las nuevas modificaciones no olvides:

```console
tv ~ # systemctl daemon-reload
```
