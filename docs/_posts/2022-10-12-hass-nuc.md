---
title: "Home Assistant en NUC"
date: "2022-10-12"
categories: domótica
tags: linux homeassistant nuc intel grafana influxdb
excerpt_separator: <!--more-->
---

![Logo Solax](/assets/img/posts/logo-hass-nuc.svg){: width="150px" style="float:left; padding-right:25px" } 

Instalación de Home Assistant OS (HAOS) en Intel NUC5i5RYK, un equipo muy potente para la tarea pero lo tenía disponible y he querido aprovecharlo. Empecé por montarlo en una Raspberry Pi4B, pasé a máquina virtual (con bastante mejor rendimiento) sobre KVM y en este apunte describo cómo he hecho la instalación sobre un NUC. 

<br clear="left"/>
<!--more-->


### Instalación

La documentación para instalar Home Assistant la encuentras [en su web](https://www.home-assistant.io/installation/). De todas las opciones disponibles elijo el **método de instalación "Home Assistant Operating System"** y la opción [**Generic x86-64 (e.g. Intel NUC), Home Assistant Operating System**](https://www.home-assistant.io/installation/generic-x86-64)

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-1.png" 
      caption="Opción de instalación elegida" 
      width="500px"
      %}

<br/>

La instalación no es obvia. Estamos acostumbrados a bajarnos una imagen, copiarla en un USB, hacer boot con él y preparar e instalar. Aquí no va así, por suerte encontré esta [guía detallada sobre la instalación de HA sobre un NUC](https://fertry.tech/posts/instalacion-home-assistant-intel-nuc-avanzado/).

El proceso es un poco más complicado. Consiste en **clonar** (copiar bit a bit) la imagen de Home Assistant OS para X86-64 sobre el disco físico del NUC. Para hacerlo necesitamos **dos usb's**, una con una imagen de Clonezilla (distribución de linux especializada en clonaciones), con la que haremos boot, y otra con el Home Assistant OS para X86-64 (que clonaremos).

El proceso resumido:

- Desde mi iMac me bajo y quemo en USB's las dos imágenes
  - USB 1) Quemo con [Balena Etcher](https://www.balena.io/etcher/) una imagen de [Clonezilla Estable](https://clonezilla.org/downloads/download.php?branch=stable) 
  - USB 2) Quemo con [Balena Etcher](https://www.balena.io/etcher/) la última [imagen de HAOS para X86-64](https://www.home-assistant.io/installation/generic-x86-64) 
- Conecto ambas USB's al NUC y hago boot pulsando F10 para poder seleccionar desde dónde hacer boot. 
- Arranco el NUC, pulso F2, configuro la Bios
  - Activo UEFI Boot
  - Deshabilito Secure Boot
- Arranco seleccionando **la USB de Clonezilla** como la unidad de arranque
- Selecciono la primera opción, teclado y región en España/Español.
- Desde Clonezilla, 
  -  Disco/Partición a Disco/Partición
  -  Modo Experto: Seleccionar tus propias opciones
  -  Disco_local a Disco_local_clonado
  -  Selecciono como origen el sdc (USB con la imagen de HAOS) y como destino el sda (SSD disco del NUC)
  -  Dejo las opciones por defecto (la -r importante que siempre esté marcada)
  -  Damos OK. 
  -  Omitir la comprobación/reparación del sistema de archivos fuente
  -  Usar la tabla de particiones del disco de origen
  -  Elija reiniciar/apagar/etc cuando todo esté terminado
  -  En la consola voy confirmando todos los comandos
  -  Cuando termina quito los dos USB's y pulso en Reiniciar


A partir de aquí sigo con el On Boarding de Home Assistant. Conecto con [homeassistant.local:8123](http://homeassistant.local:8123). 


{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-2.png" 
      caption="Inicio del `Onboarding`" 
      width="500px"
      %}


<br/>

Si no tienes que migrar una instalación antigua ya podrías seguir la [documentación oficial](https://www.home-assistant.io/getting-started/onboarding/) a partir de este punto para trabajar con tu nuevo HA.

<br/>

### Transferir HA antiguo al nuevo NUC

En mi caso si que necesité transferir la configuración completa del antiguo servidor (que tenía en una máquina virtual) a este nuevo servidor. 

<br/>

#### Servidor HA antiguo (VM)

Conecto con mi servidor antiguo (actualmente se está ejecutando en una máquina virtual) y en mi DNS server lo referencio como hass.parchis.org.

Conecto con http://hass.parchis.org:8123
- Settings --> System --> Backup --> Create Backup (Full Backup)

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-3.png" 
      caption="Creo un backup completo" 
      width="500px"
      %}

Selecciono el backup recien hecho y la opción de "Download backup". 

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-4.png" 
      caption="Descargo el backup a mi ordenador" 
      width="500px"
      %}

Crea un archivo `.tar` en mi directorio de descargas.

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-5.png" 
      caption="Fichero con el backup completo descargado en mi ordenador" 
      width="500px"
      %}


Apago el servidor antiguo. 

- Settings --> Hardware --> Shutdown System


<br/>

#### Cambio mi DHCP Server

Accedo a mi DHCP Server y modifico su configuración para que se asocie la IP (192.168.100.244) de hass.parchis.org a la MAC del nuevo NUC. Rearranco el NUC `ha > host reboot` y al activar su tarjeta de red recibe dicha IP.

<br/>

#### Recupero el backup

Conecto con http://hass.parchis.org:8123 (ahora es el NUC). 

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-6.png" 
      caption="Pido recuperar desde backup" 
      width="500px"
      %}

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-7.png" 
      caption="Selecciono el que me descargué en mi ordenador" 
      width="500px"
      %}

Tras confirmar inicia la recuperación. Ten en cuenta que tarda unos minutos sin hacer aparentemente nada. Al cabo de un rato conecté de nuevo con hass.parchis.org:8123 y comprobé que había terminado. Detecté pequeños fallos menores que resolví de forma sencilla (revisando el log).


---
