---
title: "Home Assistant en NUC"
date: "2022-10-12"
categories: domótica
tags: linux homeassistant nuc intel grafana influxdb
excerpt_separator: <!--more-->
---

![Logo Solax](/assets/img/posts/logo-hass-nuc.svg){: width="150px" style="float:left; padding-right:25px" } 

Instalación de Home Assistant OS (HAOS) en un equipo Intel NUC5i5RYK, que aunque es un equipo sobradamente potente para la tarea, lo tenía por ahí medio parado y le he querido dar un mejor uso. Hasta ahora he pasado por ejecutar Home Assistant en una Pi4, luego en una máquina virtual (con bastante mejor rendimiento) y ahora voy a probar a dedicarle todo un NUC. Aprovecho para documentarlo. 

<br clear="left"/>
<!--more-->


### Instalación

La documentación para instalar Home Assistant la encuentras [en su web](https://www.home-assistant.io/installation/). En mi caso uso el **método de instalación "Home Assistant Operating System"**, escojo la opción [**Generic x86-64 (e.g. Intel NUC), Home Assistant Operating System**](https://www.home-assistant.io/installation/generic-x86-64)

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-1.png" 
      caption="Opción de instalación elegida" 
      width="500px"
      %}

<br/>

Aquí tienes una [guía muy detallada](https://fertry.tech/posts/instalacion-home-assistant-intel-nuc-avanzado/), en resumen estos son los pasos que he realizado:

- Arranco mi NUC, pulso F2, configuro la Bios
  - Activo UEFI Boot
  - Deshabilito Secure Boot
- Necesito 2 USB's
- Quemo con [Balena Etcher](https://www.balena.io/etcher/) una imagen de [Clonezilla Estable](https://clonezilla.org/downloads/download.php?branch=stable) en una USB 
- Quemo con [Balena Etcher](https://www.balena.io/etcher/) la última [imagen de HAOS para X86-64](https://www.home-assistant.io/installation/generic-x86-64) en uan segunda USB 
- Conecto ambas USB's al NUC y hago boot pulsando F10 para poder seleccionar desde dónde hacer boot. 
- Selecciono **la USB de Clomezilla**
- Una vez arranca, selecciono la primera opción, teclado y región en España/Español, etc... 
- Desde Clonezilla, 
  -  Disco/Partición a Disco/Partición
  -  Modo Experto: Seleccionar tus propias opciones
  -  Disco_local a Disco_local_clonado
  -  Selecciono como origen el sdc (USB) y como destino el sda (SSD)
  -  Dejo las opciones por defecto (la -r importante que siempre esté marcada)
  -  Damos OK. 
  -  Omitir la comprobación/reparación del sistema de archivos fuente
  -  Usar la tabla de particiones del disco de origen
  -  Elija reiniciar/apagar/etc cuando todo esté terminado
  -  En la consola voy confirmando todos los comandos
  -  Cuando termina quito los dos USB's y pulso en Reiniciar


A partir de aquí sigo con el On Boarding de Home Assistant. Conecto con [homeassistant.local:8123](http://homeassistant.local:8123). 


{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-2.png" 
      caption="Inicio del `Onboarding`" 
      width="500px"
      %}


<br/>

Si no tienes que migrar una instalación antigua ya podrías seguir la [documentación oficial](https://www.home-assistant.io/getting-started/onboarding/) a partir de este punto para trabajar con tu nuevo HA.

<br/>

### Transferir HA antiguo al nuevo NUC

En mi caso necesito transferir la configuración completa del antiguo servidor (lo tengo en una máquina virtual) a este nuevo servidor en un NUC el proceso es relativamente sencillo. 

<br/>

#### Servidor HA antiguo (VM)

Conecto con mi servidor antiguo (actualmente se está ejecutando en una máquina virtual) y en mi DNS server lo referencio como hass.parchis.org.

Conecto con http://hass.parchis.org:8123
- Settings --> System --> Backup --> Create Backup (Full Backup)

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-3.png" 
      caption="Creo un backup completo" 
      width="500px"
      %}

Selecciono el backup recien hecho y la opción de "Download backup". 

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-4.png" 
      caption="Descargo el backup a mi ordenador" 
      width="500px"
      %}

Crea un archivo `.tar` en mi directorio de descargas.

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-5.png" 
      caption="Fichero de backup completo" 
      width="500px"
      %}


Apago el servidor antiguo. 

- Settings --> Hardware --> Shutdown System


<br/>

#### Cambio mi DHCP Server

Accedo a mi DHCP Server y asocio a la MAC de la Ethernet de mi NUC la IP que tenía el HA antiguo, de modo que no tengo que cambiar nada en el DNS Server. 

Rearranco el nuevo HA para que se le asigne a él la misma IP que tenía el antiguo. Desde la consola ejecuto: 

`ha > host reboot`


<br/>

#### Recupero el backup

Una vez que ha arrancado conecto con http://hass.parchis.org:8123. Ahora estoy conectando con el nuevo HAOS corriendo en el NUC. 

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-6.png" 
      caption="Descargo el backup a mi ordenador" 
      width="500px"
      %}

{% include showImagen.html 
      src="/assets/img/posts/2022-10-12-hass-nuc-7.png" 
      caption="Descargo el backup a mi ordenador" 
      width="500px"
      %}

Me pide confirmación, le digo que sí estoy seguro y empieza la recuperación. Se quedará en la ventana de "Onboarding". Espera unos minutos porque parece que se no hace nada, pero en el background está restaurando y rearrancando HA. 

Al cabo de unos minutos pruebo a conectar con hass.parchis.org:8123 y veo que aparentemente está todo, aunque sigue cargando. Al final termina de cargar todo y el sistema está funcionando, me quedan algunos retoques menores que me avisa en la pantalla de log y son sencillos de resolver. 


---
