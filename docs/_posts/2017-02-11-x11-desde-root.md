---
title: "SSH y X11 como root"
date: "2017-02-11"
categories: linux
tags: x11 xorg x window xfree86 ssh linux
excerpt_separator: <!--more-->
---


![logo rsync](/assets/img/posts/logo-XOrg.svg){: width="150px" height="150px" style="float:left; padding-right:25px" } 

El objetivo es **que las aplicaciones que necesitan X11 (X-Window) funcionen desde root**. Que que funcionen desde un usuario normal es f√°cil, pero **entrar luego a root con `su/sudo` y que X11 siga funcionando no est√° permitido en Linux**. La conexi√≥n X11 *solo* pertenece al usuario con el que entraste por SSH. 

<br clear="left"/>
<!--more-->

Sin embargo **siempre hay un truco ü§ó**, aunque me adelanto un poco, la soluci√≥n pasa por reutilizar las credenciales X11 del usuario original, su `lista de cookies`, que se las prestaremos a `root` usando `xauth add`, lo vemos m√°s adelante. 

<br/> 

### Configuraci√≥n SSH

He documentado en otro apunte una [introducci√≥n a SSH]({% post_url 2009-02-01-ssh %}) por si est√°s interesado. Aqu√≠ vamos a ver de nuevo la configuraci√≥n de SSH en ambos, servidor y cliente, centr√°ndome en la parte de X11. Si quieres saber sobre SSH consulta la [documentaci√≥n oficial de openssh](https://www.openssh.com/manual.html)

<br/> 

#### Servidor SSH y X11

Conectar√© como `luis` (desde un Mac llamado `idefix`) a un servidor linux con SSHD llamado `cortafuegix (gentoo)`. Esta es la configuraci√≥n SSH del servidor: 

* Configuraci√≥n del Servidor `cortafuegix`

```
cortafuegix ~ # cat /etc/ssh/sshd_config
# Config LuisPa
PubkeyAuthentication yes
PasswordAuthentication no
AuthenticationMethods publickey
UsePAM no
X11Forwarding yes     # !! X11 !!
X11DisplayOffset 10   # !! X11 !!
X11UseLocalhost yes   # !! X11 !!
AddressFamily inet
PrintMotd no
PrintLastLog no
Subsystem	sftp	/usr/lib64/misc/sftp-server
AcceptEnv LANG LC_*
```

<br/> 

#### Cliente SSH y X11

El cliente SSH que utilizo es el que viene con MacOS (`idefix`). Este es el fichero de configuraci√≥n que uso en mi usuario `luis`. 

* Configuraci√≥n del cliente MacOS `idefix`

```
‚ûú  ~ > confcat /Users/luis/.ssh/config 
PubkeyAuthentication yes
Host *
    ForwardAgent yes        
    ForwardX11 yes          # !! X11 !!
    ForwardX11Trusted yes   # !! X11 !!
    ControlMaster auto
    ControlPath ~/.ssh/sockets/%r@%h-%p
    ControlPersist 600
    AddKeysToAgent yes
    UseKeychain yes
    IdentityFile ~/.ssh/id_rsa
```

<br/>

Dentro de las configuraciones la parte relacionada con X11 es la siguiente: 

<br/>

* En el **SERVIDOR**: 
  * `X11Forwarding yes`: Permito reenv√≠o de X11 con mis clientes
  * `X11DisplayOffset 10`: Primer n√∫mero de pantalla (Variable DISPLAY)
  * `X11UseLocalhost yes`: Asociar el reenv√≠o de X11 a la direcci√≥n `loopback`

<br/>

* En el **CLIENTE**:
  * `ForwardX11 yes`: Permito reenv√≠o de X11
  * `ForwardX11Trusted yes`: Conectar con `-X` o `-Y` tendr√° el mismo efecto
 
<br/>

En **terminolog√≠a X-Window** se llama **Servidor a lo que vemos**, en el mac **XQuartz** es el servidor y muestra en pantalla lo le piden los clientes remotos. Se llama **Cliente a las Aplicaciones**, en este caso un **ejemplo ser√≠a `xclock` ejecut√°ndose en el linux**.

Al poner **`ForwardX11Trusted yes`** en el Mac lo que estoy diciendo es que **ignore la extensi√≥n "X11 SECURITY"** que provoca que **cualquier Aplicaci√≥n del linux podr√° acceder a mi Servidor XQuartz**. 

{% include showImagen.html 
      src="/assets/img/posts/x11-desde-root-1.png" 
      caption="Preferencias XQuartz en cliente Mac." 
      width="600px"
      %}

Para que funcione X11 desde el cliente usaremos `ssh -X` o `ssh -Y`. La primera (`-X`) consulta `ForwardX11Trusted` mientras que la segunda (`-Y`) la ignora. Al poner su valor a `yes`estoy diciendo que da igual conectar con una o la otra, en ambos casos se ignora la extensi√≥n de seguridad "X11 SECURITY", es decir que **da igual si conecto con `-X` o `-Y` que el efecto ser√° el mismo**.


<br/> 

### Prueba de concepto

Para empezar desde cero, borro el fichero `$HOME/.Xauthority` en mi servidor (adem√°s de cualquier fichero `$HOME/.xauth*`), tanto en mi usuario `luis`como en `root`.

La autenticaci√≥n X se basa en **cookies**, un chorro de datos que solo el servidor y tu usuario conocen. Al conectar se crea una magic-cookie y se archiva en `$HOME/.Xauthority`. Si vemos a continuaci√≥n, al conectar no exist√≠a y se crea (lo hace el servidor `sshd`), insertando la **magic cookie** y establece la variable `DISPLAY`. 

```
‚ûú  ~ > 
‚ûú  ~ > ssh -X luis@cortafuegix.parchis.org 
/usr/bin/xauth:  file /home/luis/.Xauthority does not exist
luis@cortafuegix ~ $ ls -al .Xauthority 
-rw------- 1 luis luis 57 may  3 11:48 .Xauthority
luis@cortafuegix ~ $ xauth list
cortafuegix/unix:11  MIT-MAGIC-COOKIE-1  afd3b06294cd3963efade050a69c7c4b
luis@cortafuegix ~ $ echo $DISPLAY
localhost:11.0
luis@cortafuegix ~ $ 
luis@cortafuegix ~ $ xclock
```

{% include showImagen.html 
      src="/assets/img/posts/x11-desde-root-2.png" 
      caption="SSH y xclock como usuario 'luis'" 
      width="600px"
      %}

El problema es cuanto ejecuto `su -` o `sudo su -` para convertirme en root dejamos de poder ejecutar aplicaciones X11. 

```
‚ûú  ~ > ssh -Y -a luis@cortafuegix.parchis.org
luis@cortafuegix ~ $

luis@cortafuegix:~$ xclock <=== FUNCIONA ^C 
luis@cortafuegix:~$ su - <=== O bien "sudo su -" 
root@cortafuegix:~# xclock <=== FALLA 
Error: Can't open display: localhost:10.0
```

### La soluci√≥n

La autenticaci√≥n X se basa en **cookies**,¬†b√°sicamente un chorro de datos que solo el servidor y tu usuario conocen. En el ejemplo anterior cuando¬†`luis`¬†conecta v√≠a `ssh`¬†con el servidor `marte`¬†todo funciona, la primera vez se crea dicha cookie y se archiva en el directorio `HOME` del usuario `luis` (`~/.Xauthority`). ¬†Para que tambi√©n nos funcione al convertirnos en `root` tenemos que pasarle dicha cookie.

Lo primero es averiguar la cookie de `luis` para el valor de la variable `DISPLAY` actual:

```
ssh -a -Y -l luis marte.parchis.org
luis@marte.parchis.org's password:
luis@marte:~$ xauth list $DISPLAY
marte/unix:10 MIT-MAGIC-COOKIE-1 d0e149825311234567855be818cb1ebf
```

Despu√©s entramos en "`su -`" o "`sudo su -`" y ya como root a√±adimos la cookie. La primera vez se quejar√° de que el fichero `.Xauthority` no existe, simplemente ign√≥ralo porque lo va a crear.

```
luis@marte:~$ s
root@marte:~# xauth add marte/unix:10 MIT-MAGIC-COOKIE-1 d0e149825311234567855be818cb1ebf
xauth: file /root/.Xauthority does not exist
root@marte:~# ls -al .Xauthority
-rw------- 1 root root 51 feb 11 12:32 .Xauthority
root@marte:~# xclock    <== FUNCIONA !!!!!!
^C
```

Hasta aqu√≠ todo bien pero no es permanente, por ejemplo al re-arrancar el servidor, el sshd, etc... se regenerar√°n los cookies y tendr√≠amos a volver a empezar.

<br/>

### Soluci√≥n permanente

Ahora que hemos entendido c√≥mo funciona te presento la mejor soluci√≥n,

```
/root/.profile
export XAUTHORITY=/home/luis/.Xauthority
```


Consiste en usar la variable de entorno `XAUTHORITY` apuntando al¬†fichero `.Xauthority` del usuario (en mi ejemplo `luis`), la pones en el `.profile` de root y ya est√°.¬†**No necesitas** ejecutar el comando `xauth` y **no necesitas** el fichero `/root/.Xauthority`.



### xclock: Resolver el "Missing charsets..."

Lo habr√©is visto mil veces, este error, cuando est√°is arrancando `xclock` en un equipo linux y aunque es un error cosm√©tico, es bastante molesto.

```
luis@tierra:~$ xclock
Warning: Missing charsets in String to FontSet conversion
Warning: Unable to load any usable fontset
```

La soluci√≥n es super sencilla, yo la tengo puesta en mi `/etc/profile` de los equipos linux a los que conecto, por lo que soluciona el problema a cualquier usuario.

```
root@tierra:~# cat /etc/profile
:
alias xclock='LC_ALL=C /usr/bin/xclock'
````


