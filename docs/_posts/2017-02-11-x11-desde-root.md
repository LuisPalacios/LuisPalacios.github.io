---
title: "SSH y X11 como root"
date: "2017-02-11"
categories: linux
tags: x11 xorg x window xfree86 ssh linux
excerpt_separator: <!--more-->
---


![logo rsync](/assets/img/posts/logo-XOrg.svg){: width="150px" height="150px" style="float:left; padding-right:25px" } 

El objetivo es **que las aplicaciones que necesitan X11 (X-Window) funcionen desde root**. Que que funcionen desde un usuario normal es f√°cil, pero **entrar luego a root con `su/sudo` y que X11 siga funcionando no est√° permitido en Linux**. La conexi√≥n X11 *solo* pertenece al usuario con el que entraste por SSH. 

<br clear="left"/>
<!--more-->

Sin embargo **siempre hay un truco ü§ó**, aunque me adelanto un poco, la soluci√≥n pasa por reutilizar las credenciales X11 del usuario original, su `lista de cookies`, que se las prestaremos a `root` usando `xauth add`, lo vemos m√°s adelante. 

<br/> 

### Configuraci√≥n SSH

He documentado en otro apunte una [introducci√≥n a SSH]({% post_url 2009-02-01-ssh %}) por si est√°s interesado. Aqu√≠ vamos a ver de nuevo la configuraci√≥n de SSH en ambos, servidor y cliente, centr√°ndome en la parte de X11. Si quieres saber sobre SSH consulta la [documentaci√≥n oficial de openssh](https://www.openssh.com/manual.html)

<br/> 

#### Servidor SSH y X11

Conectar√© como `luis` (desde un Mac llamado `idefix`) a un servidor linux con SSHD llamado `cortafuegix (gentoo)`. Esta es la configuraci√≥n SSH del servidor: 

* Configuraci√≥n del Servidor `cortafuegix`

```
cortafuegix ~ # cat /etc/ssh/sshd_config
# Config LuisPa
PubkeyAuthentication yes
PasswordAuthentication no
AuthenticationMethods publickey
UsePAM no
X11Forwarding yes     # !! X11 !!
X11DisplayOffset 10   # !! X11 !!
X11UseLocalhost yes   # !! X11 !!
AddressFamily inet
PrintMotd no
PrintLastLog no
Subsystem	sftp	/usr/lib64/misc/sftp-server
AcceptEnv LANG LC_*
```

<br/> 

#### Cliente SSH y X11

El cliente SSH que utilizo es el que viene con MacOS (`idefix`). Este es el fichero de configuraci√≥n que uso en mi usuario `luis`. 

* Configuraci√≥n del cliente MacOS `idefix`

```
‚ûú  ~ > confcat /Users/luis/.ssh/config 
PubkeyAuthentication yes
Host *
    ForwardAgent yes                    # (*) !!
    ForwardX11 yes                      # !! X11 !!
    ForwardX11Trusted yes               # !! X11 !!
    XAuthLocation /opt/X11/bin/xauth    # !! X11 !!
    ControlPath ~/.ssh/sockets/%r@%h-%p
    ControlPersist 600
    AddKeysToAgent yes
    UseKeychain yes
    IdentityFile ~/.ssh/id_rsa
```

<br/>

Dentro de las configuraciones la parte relacionada con X11 es la siguiente: 

<br/>

* En el **SERVIDOR**: 
  * `X11Forwarding yes`: Permito reenv√≠o de X11 con mis clientes
  * `X11DisplayOffset 10`: Primer n√∫mero de pantalla (Variable DISPLAY)
  * `X11UseLocalhost yes`: Asociar el reenv√≠o de X11 a la direcci√≥n `loopback`

<br/>

* En el **CLIENTE**:
  * `ForwardAgent yes`: PENDIENTE DE CONFIRMAR (*) !!
  * `ForwardX11 yes`: Permito reenv√≠o de X11
  * `ForwardX11Trusted yes`: Conectar con `-X` o `-Y` tendr√° el mismo efecto
  * `XAuthLocation /opt/X11/bin/xauth`: Para evitar el error "No xauth data..."
  
<br/>

En **terminolog√≠a X-Window** se llama **Servidor a lo que vemos**, en el mac **XQuartz** es el servidor y muestra en pantalla lo le piden los clientes remotos. Se llama **Cliente a las Aplicaciones**, en este caso un **ejemplo ser√≠a `xclock` ejecut√°ndose en el linux**.

Nota: Si `xclock` te da el error "Warning: Missing charsets in String to FontSet conversion" la soluci√≥n es sencilla, modifica tu `/etc/profile` a√±ade lo siguiente: `alias xclock='LC_ALL=C /usr/bin/xclock'`


Al poner **`ForwardX11Trusted yes`** en el Mac lo que estoy diciendo es que **ignore la extensi√≥n "X11 SECURITY"** que provoca que **cualquier Aplicaci√≥n del linux podr√° acceder a mi Servidor XQuartz**. 

{% include showImagen.html 
      src="/assets/img/posts/x11-desde-root-1.png" 
      caption="Preferencias XQuartz en cliente Mac." 
      width="600px"
      %}

Para que funcione X11 desde el cliente usaremos `ssh -X` o `ssh -Y`. La primera (`-X`) consulta `ForwardX11Trusted` mientras que la segunda (`-Y`) la ignora. Al poner su valor a `yes`estoy diciendo que da igual conectar con una o la otra, en ambos casos se ignora la extensi√≥n de seguridad "X11 SECURITY", es decir que **da igual si conecto con `-X` o `-Y` que el efecto ser√° el mismo**.


<br/> 

### Prueba de concepto

Para empezar desde cero, borro el fichero `$HOME/.Xauthority` en mi servidor (adem√°s de cualquier fichero `$HOME/.xauth*`), tanto en mi usuario `luis`como en `root`.

La autenticaci√≥n X se basa en **cookies**, un chorro de datos que solo el servidor y tu usuario conocen. Al conectar se crea una magic-cookie y se archiva en `$HOME/.Xauthority`. Si vemos a continuaci√≥n, al conectar no exist√≠a y se crea (lo hace el servidor `sshd`), insertando la **magic cookie** y establece la variable `DISPLAY`. 

```
‚ûú  ~ > 
‚ûú  ~ > ssh -X luis@cortafuegix.parchis.org 
/usr/bin/xauth:  file /home/luis/.Xauthority does not exist
luis@cortafuegix ~ $ ls -al .Xauthority 
-rw------- 1 luis luis 57 may  3 11:48 .Xauthority
luis@cortafuegix ~ $ xauth list
cortafuegix/unix:11  MIT-MAGIC-COOKIE-1  afd3b06294cd3963efade050a69c7c4b
luis@cortafuegix ~ $ echo $DISPLAY
localhost:11.0
luis@cortafuegix ~ $ 
luis@cortafuegix ~ $ xclock
```

{% include showImagen.html 
      src="/assets/img/posts/x11-desde-root-2.png" 
      caption="SSH y xclock como usuario 'luis'" 
      width="600px"
      %}

El problema viene al convertirme en `root`, da igual el m√©todo que utilice, tenga o no la variable `DISPLAY` que nunca consigo que funcione: 

```zsh
‚ûú  ~ > ssh -X luis@cortafuegix.parchis.org
luis@cortafuegix ~ $ su  (Da igual el comando: "su -", "sudo -i", "sudo su -")
:
cortafuegix ~ # echo $DISPLAY
localhost:10.0
cortafuegix /home/luis # xclock
X11 connection rejected because of wrong authentication.
Error: Can't open display: localhost:10.0
```

{% include showImagen.html 
      src="/assets/img/posts/x11-desde-root-3.png" 
      caption="Por defecto no ser√° posible conectar" 
      width="600px"
      %}


### La soluci√≥n

Como dec√≠a, la autenticaci√≥n X se basa en **cookies**, un chorro de datos que solo el servidor y tu usuario conocen. En el ejemplo anterior cuando¬†`luis`¬†conecta v√≠a `ssh`¬†con el servidor todo funciona, la primera vez se crea dicha cookie en (`~/.Xauthority`). ¬†Para que tambi√©n nos funcione al convertirnos en `root` tenemos que conseguir pasarsela. 

**M√©todo 1: Copia manual desde mi usuario**

Este m√©todo funciona muy bien si soy el √∫nico que entra en `root`en mis servidores. B√°sicmaente modifico el `.profile` de `root` y me a√±ado la cookie de `luis` en mi propio fichero `.Xauthority`. 

```
cortafuegix ~ # cat .profile 
:
su - luis -c 'xauth list' |\
              grep -E "localhost|`hostname`" |\
              xargs -n 3 xauth add
```

Ten en cuenta que **se tiene que ejecutar el .profile** o no funcionar√°, por lo tanto: 

* Funcionar√°: Cuando entres como `root` con `su -`, `sudo -i`, `sudo su -` o cuando ejecuto desde luis `sudo -i xclock`
* No funcionar√° la primera vez si entro con `su` o intento ejecutar `sudo xclock`, porque NO se ejecuta el `.profile`. Ahora bien, si ya he entrado alguna vez con los anteriores, entonces estos empezar√°n a funcionar. 

{% include showImagen.html 
      src="/assets/img/posts/x11-desde-root-4.png" 
      caption="Empieza a funcionar" 
      width="400px"
      %}

OJO! **funcionar, funciona, pero es un poco chapuza** porque solo le funcionar√° a un usuario (imagina un linux con m√∫ltiples usuario entrando como root) y porque te puede despistar que a veces no vaya... dependiendo de qu√© comando uses y si est√° o no creado el .Xauthority.

<br/>

### M√©todo 2

Esta opci√≥n es otra peque√±a chapuzilla... consiste en usar la variable de entorno `XAUTHORITY` apuntando al¬†fichero `.Xauthority` del usuario (en mi ejemplo `luis`), la pones en el `.profile` de root y ya est√°.¬†**No necesitas** ejecutar el comando `xauth` y **no necesitas** el fichero `/root/.Xauthority`.

```
/root/.profile
export XAUTHORITY=/home/luis/.Xauthority
```

Ahora bien, tampoco me gusta demasiado, as√≠ que no la he activado. Veamos la tercera opci√≥n. 

<br/>

**M√©todo 2: usar PAM !!!**

Existe la posibildiad de activar el m√≥dulo `pam_xauth.so` en la √∫ltima l√≠nea del fichero `/etc/pam.d/su`: 

```
session optional pam_xauth.so
```

Al convertirte en `root` se crear√° autom√°ticamente en el HOME de root un fichero del tipo `./xauthXXXXXX` (siendo XXXXXX valores aleatorios) con la cookie del usuario que entr√≥ como root, y al salir de la sesi√≥n se eliminar√° este ficher temporal. Se puede encontrar m√°s informaci√≥n en `man pam_xauth`

Por lo tanto, comento lo que hice en la opci√≥n 1, en el `.profile` y activo esta nueva opci√≥n en `/etc/pam.d/su`:

```
cortafuegix ~ # cat .profile 
:
#su - luis -c 'xauth list' |\
#              grep -E "localhost|`hostname`" |\
#              xargs -n 3 xauth add

cortafuegix ~ # cat /etc/pam.d/su
:
session		optional	pam_xauth.so

```

Esta opci√≥n es **un poco m√°s pura linux** aunque como ver√°s en la tabla siguiente tampoco cubre todos los casos.

<br/>

**Resumen de Opciones**

Dependiendo de qu√© versi√≥n configures tendr√°s un entorno X11 en `root` funcionando (OK) o fallando (FALLA). 

|  | (1) .profile |  (2) XAUTHORITY |  (3) pam_xauth.so |
| -- | -- | -- | -- |
| su | SEMIFALLA | FALLA | OK |
| su - | OK | OK | OK |
| sudo su - | OK | OK | FALLA |
| sudo -i | OK | OK | FALLA |
| sudo xclock | SEMIFALLA | FALLA | FALLA
| sudo -i xclock | OK | OK | FALLA

Elije la que m√°s te convenga. Aunque no es demasiado purista en mi caso estoy usando las opciones (1) y (3) simult√°neamente ü§ó y adem√°s a√±ado la siguiente l√≠nea al final de mi `.bashrc` del usuario `luis` para que me evitar el SEMIFALLO de "sudo \<comando>": 

```
alias sudo='sudo -i'
```

