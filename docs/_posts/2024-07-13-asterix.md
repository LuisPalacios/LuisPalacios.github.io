---
title: "Asterisk en Linux"
date: "2024-07-13"
categories: administración
tags: linux movistar mac iptables router software asterisk
excerpt_separator: <!--more-->
---

![logo user](/assets/img/posts/logo-asterisk.svg){: width="150px" height="150px" style="float:left; padding-right:25px" }

[`asterisk`](https://www.asterisk.org/) Asterisk es un programa de software libre (bajo licencia GPL) que proporciona funcionalidades de una central telefónica (PBX). Como cualquier PBX, se puede conectar un número determinado de teléfonos para hacer llamadas entre sí dentro de una misma organización e incluso acceder a comunicaciones fuera de la misma a la PSTN o conectando a un proveedor de VoIP o bien a una RDSI tanto básicos como primarios.

<br clear="left"/>
<!--more-->

## Introducción

Originalmente desarrollado para el sistema operativo GNU/Linux, Asterisk actualmente también se distribuye en versiones para BSD, MacOS, Solaris y Microsoft Windows. Es una PBX con soporte de buzón de voz, conferencias, IVR, distribución automática de llamadas, etc. Para conectar teléfonos estándares analógicos son necesarias tarjetas electrónicas telefónicas FXO (red de operador) y/o FXS (red interna).

Asterisk soporta muchos protocolos VoIP: SIP, H.323, IAX y MGCP, puede interoperar con terminales IP actuando como un registrador y como gateway entre ambos; permite la unificación de tecnologías: VoIP, GSM y PSTN.

Mi caso de uso es muy sencillo, configuro Asterisk en el mismo [router Linux para Movistar]({% post_url 2014-10-05-router-linux %}) que tengo en casa para aprovechar los servicios de Datos, Televisión (IPTV) y Voz (VoIP) de mi contrato. El objetivo es poder usar Asterisk como punto intermedio para poder hacer llamadas desde clientes VoIP en mi casa. Además de Asterisk voy a instalar FreePBX, una GUI basada en Web que controla y dirige Asterisk

## Instalación

Actualizo mi Ubuntu a la última

```zsh
[root]@cortafuegix:~# apt update && apt upgrade -y && apt full-upgrade
```

Descargo e instalo el software

```zsh
[root]@cortafuegix:~# apt install asterisk
:
[root]@cortafuegix:~# asterisk -V
Asterisk 18.10.0~dfsg+~cs6.10.40431411-2
```

Instalo los sonidos de respuesta a las llamadas, mensajes, etc en Español, al terminar compruebo qué paquetes se han instalado

```zsh
[root]@cortafuegix:~# apt install asterisk-core-sounds-es asterisk-core-sounds-es-g722 asterisk-core-sounds-es-gsm asterisk-core-sounds-es-wav
:
[root]@cortafuegix:~# dpkg -l | grep -i asterisk
:
```

Estos son los comandos de administración: `service asterisk [ start | stop | restart | status ]`. Compruebo el estado con `status`:

```zsh
[root]@cortafuegix:~# service asterisk status
● asterisk.service - Asterisk PBX
     Loaded: loaded (/lib/systemd/system/asterisk.service; enabled; vendor preset: enabled)
     Active: active (running) since Sat 2024-07-13 17:35:49 CEST; 17min ago
       Docs: man:asterisk(8)
   Main PID: 6767 (asterisk)
      Tasks: 69 (limit: 3425)
     Memory: 48.1M
        CPU: 3.915s
     CGroup: /system.slice/asterisk.service
             ├─6767 /usr/sbin/asterisk -g -f -p -U asterisk
             └─6768 astcanary /var/run/asterisk/alt.asterisk.canary.tweet.tweet.tweet 6767

jul 13 17:35:49 cortafuegix systemd[1]: Starting Asterisk PBX...
jul 13 17:35:49 cortafuegix asterisk[6767]: radcli: rc_read_config: rc_read_config: can't open /etc/radiusclient-ng/radiusclient.conf: No such file or directory
jul 13 17:35:49 cortafuegix asterisk[6767]: radcli: rc_read_config: rc_read_config: can't open /etc/radiusclient-ng/radiusclient.conf: No such file or directory
jul 13 17:35:49 cortafuegix systemd[1]: Started Asterisk PBX.
```

Se queja sobre que no encuentra archivos bajo `/etc/radiusclient-ng`. Por defecto trabaja en ese directorio, pero el proceso de instalación instala en otro sitio, así que cambio los ficheros de configuración. Primero hago una copia de seguridad

```zsh
[root]@cortafuegix:~# cd /etc/asterisk
[root]@cortafuegix:/etc/asterisk# cp cel.conf cel.conf.bak
[root]@cortafuegix:/etc/asterisk# cp cdr.conf cdr.conf.bak
```

En el archivo `/etc/asterisk/cel.conf`:

```conf
radiuscfg => /etc/radcli/radiusclient.conf
```

En el archivo `/etc/asterisk/cdr.conf`:

```conf
[radius]
radiuscfg => /etc/radcli/radiusclient.conf
```

Rearranco el servicio y miro su estado:

```zsh
[root]@cortafuegix:/etc/asterisk# service asterisk restart
[root]@cortafuegix:/etc/asterisk# service asterisk status
● asterisk.service - Asterisk PBX
     Loaded: loaded (/lib/systemd/system/asterisk.service; enabled; vendor preset: enabled)
     Active: active (running) since Sat 2024-07-13 18:56:14 CEST; 2s ago
       Docs: man:asterisk(8)
   Main PID: 8497 (asterisk)
      Tasks: 80 (limit: 3425)
     Memory: 41.9M
        CPU: 406ms
     CGroup: /system.slice/asterisk.service
             ├─8497 /usr/sbin/asterisk -g -f -p -U asterisk
             └─8498 astcanary /var/run/asterisk/alt.asterisk.canary.tweet.tweet.tweet 8497

jul 13 18:56:14 cortafuegix systemd[1]: Starting Asterisk PBX...
jul 13 18:56:14 cortafuegix systemd[1]: Started Asterisk PBX.
```

## Configuración

Los dos archivos de configuración más importantes son `sip.conf` y `extensions.conf`.

- `sip.conf`: Define los canales SIP, peers, tanto para llamadas entrantes como salientes.
- `extensions.conf`: Define el comportamiento que va a tener una llamada en nuestra centralita, qué reglas rigen su enrutamiento y qué aplicaciones va a ejecutar (`dialplan`)

### Configuración de sip.conf

Voy a configurar tres usuarios.

- `luispa` con la extensión `101`
- `luison` con la extensión `102`
- `jacobo` con la extensión `103`

De nuevo me hago copia de seguridad

```zsh
[root]@cortafuegix:~# cd /etc/asterisk
[root]@cortafuegix:/etc/asterisk# cp sip.conf sip.conf.bak
```

Modifico el fichero [sip.conf](https://gist.github.com/LuisPalacios/985adb8affd58e679c103b7ecf512de6)

{% gist 985adb8affd58e679c103b7ecf512de6 %}

### Consola de Asterix

Podemos conectar contra un CLI del propio Asterix.

```zsh
[root]@cortafuegix:~# asterisk -rvvv
:
Connected to Asterisk 18.10.0~dfsg+~cs6.10.40431411-2 currently running on cortafuegix (pid = 8497)
cortafuegix*CLI>
```

Comandos útiles:

```conf
cortafuegix*CLI> sip show peers
cortafuegix*CLI> sip show users
cortafuegix*CLI> sip reload
cortafuegix*CLI> dialplan reload
cortafuegix*CLI> core show channels
cortafuegix*CLI> sip show channels
```

## Plan de marcado (dialplan)

## Primera llamada
