---
title: "Rclone y Mac"
date: "2023-11-13"
categories: infraestructura
tags: linux mac macbook sincronizar thunderbolt usb rclone clonar rsync
excerpt_separator: <!--more-->
---

![logo rclone](/assets/img/posts/logo-rclone.svg){: width="150px" height="150px" style="float:left; padding-right:25px" } 

En este apunte explico cómo trabajo con mis datos en mi Mac mini junto con `iCloud` y `rclone` para ir a máxima velocidad, acceder desde cualquier lugar a los datos principales (HD), tener un almacen (Baul) para los menos accedidos y como "todo puede fallar", contar con al menos 3 copias de seguridad (Trastero). 

Tengo el disco interno, varios externos, iCloud y un linux remoto con un disco para backups. Además pensando en  contratar con dropbox o Google. Muchos sitios y diferentes tecnologías, ahí es donde me ayuda `rclone`.

<br clear="left"/>
<!--more-->

# Introducción

Utilizo un Mac Mini como equipo principal y varios dispositivos secundarios (móvil, iPad, laptop linux). Mis datos están en dos sitios: carpeta principal `priv` a la que quiero poder acceder desde cualquiera de los dispositivos y carpeta secundaria `Baul`, un almacén de datos al que solo necesito acceder desde el Mac. 

He decidido poner `priv` en `iCloud` y `Baul` en un disco externo conectado al Mac. El backup del Mac se hará con `TimeMachine` en otro disco externo y además voy a conectar un tercer disco externo llamado `Trastero` y un servidor remoto vía VPN llamado `luna` para los backups. Ah!, estoy pensando tener además espacio en Dropbox o Google... 

* rclone

[rclone](https://rclone.org) es una poderosa herramienta de línea de comandos que permite gestionar y sincronizar archivos y directorios. Es una herramienta versátil que te ayudará a administrar tus datos de manera efectiva, hacer copias de seguridad en servicios en la nube, en discos externos locales, remotos y mantenerlos sincronizados entre todos ellos.


<br/>

### Instalación de rclone en macOS

Para instalar rclone en macOS, sigue estos pasos:

1. Abre el Terminal en tu Mac.

2. Instala [Homebrew](https://brew.sh) si aún no lo tienes instalado. 

3. Ejecuta el siguiente comando para instalar rclone:

   ```shell
   brew install rclone
   :
   => Caveats
   Homebrew's installation does not include the `mount` subcommand on MacOS.
   zsh completions have been installed to:
   /opt/homebrew/share/zsh/site-functions
   ```

4. Verifica que rclone se haya instalado correctamente:

   ```shell
   rclone version
   ```

<br/>

### Instalación de rclone en Linux

La instalación de rclone en Linux es igualmente sencilla. A continuación, se describen los pasos generales:

1. Abre un Terminal en tu distribución Linux.

2. Puedes utilizar el administrador de paquetes de tu distribución para instalar rclone. Por ejemplo, en Ubuntu, puedes ejecutar:

   ```shell
   sudo apt-get install rclone
   ```

   En otras distribuciones, como Fedora, CentOS o Debian, puedes utilizar el administrador de paquetes correspondiente.

3. Verifica la instalación ejecutando:

   ```shell
   rclone version
   ```

<br/>

### Mi Mac Mini

#### Contexto

El disco duro principal interno del Mac "Macintosh HD" (`HD` a partir de ahora) tiene el Sistema Operativo, las aplicaciones y el HOME de mi usuario (`/Users/luis`). Los datos están en dos sitios: carpeta principal `priv` alojada en iCloud y la carpeta `Baul` en un disco externo para datos a los que solo necesito acceder desde el Mac. Además conecto un tercer disco externo llamado `Trastero` y un servidor remoto vía VPN llamado `luna` para los backups. Ah!, estoy pensando tener además espacio en Dropbox o Google... 

Respecto a los datos en iCloud: Ejecuté "Descargar ahora" (desde el Finder) en mi Mac Mini para conseguir una copia completa en local y a la vez sincronizada permanentemente con iCloud. Las ventajas son 1: dos copias del dato, 2: copia local descargada por completo y 3: acceso desde cualquier dispositivo Apple. Ah!, 4: Más adelante sincronizaré con Dropbox o Google dicha carpeta usando `rclone` para poder acceder desde Linux.




Este es el plan de copias de seguridad: 

| Dato | Origen | Dónde se hace el backup |
| -- | -- | -- |
| HD | Disco interno | `TimeMachine` disco externo USB |
| `priv` | iCloud (Datos principales) | Sincroniza en `HD`, en `Trastero` (`rclone`) y linux remoto (`rclone`). Más adelante también en Dropbox/Google (`rclone`) |
| `Baul` | Disco externo (Datos almacén) | En `Trastero` (`rclone`) y en linux remoto (`rclone`) |
| `Trastero` | Disco externo (solo para Backups) | N/A |

<br/>

#### Configuración de rclone
Antes de sincronizar localmente, con servicios en la nube u ordenadores remotos, es necesario configurar los destinos (almacenamientos remotos):

| Nota: Toda la configuración reside en `~/.config/rclone/rclone.conf` |

1. Ejecuta el siguiente comando para iniciar la configuración de rclone:

   ```shell
   rclone config
   ```

2. Puedes seguir las instrucciones del asistente de configuración para añadir un nuevo almacenamiento remoto. Puedes elegir entre una amplia gama de servicios en la nube y sistemas de archivos locales.

3. Proporciona la información requerida, como las credenciales de acceso, y asigna un nombre al almacenamiento remoto para referencia futura.

4. Una vez configurado el almacenamiento remoto, puedes utilizar rclone para sincronizar tus directorios con él.

En mi caso voy a empezar con un par de discos Thunderbolt externos locales llamados `Baul`y `Trastero`. Al montarse en mi Mac quedan disponibles para ser utilizados por `rclone`. Veamos un ejemplo de cómo quedó mi fichero `~/.config/rclone/rclone.conf` tras mi configuración inicial:

```config
[Baul]
type = alias
remote = /Volumes/Baul

[Trastero]
type = alias
remote = /Volumes/Trastero

[iCloud]
type = alias
remote = /Users/luis/Library/Mobile Documents/com~apple~CloudDocs
```


| IMPORTANTE: Para que los datos de iCloud estén siempre en mi disco duro local (físicamente, además de estar sincronizados) y poder usar `rclone` con ellos, es importante indicarle a macOS que se los baje a local. Usando el Finder > iCloud > botón derecho sobre `priv` > "Descargar ahora". Se bajará una copia completa que sincroniza permanentemente con iCloud. En mi caso 150GB de mi directorio principal. |

<br/>

{% include showImagen.html 
      src="/assets/img/posts/2023-11-13-rclone-05.drawio.svg" 
      caption="Diseño completo de backups"
      width="500px"
      %}


<br/>


### Sincronizar directorios entre dos discos locales

Para el típico backup entre dos discos. En este ejemplo quiero sincronizar los directorios `fotos` y `gestión` desde el disco externo `Baul` a `Trastero`. Recomiendo usar `--dry-run` o `check` para probar primero. 

Preparo las carpetas destino de los Backups

```shell
mkdir -p /Volumes/Trastero/Baul
mkdir -p /Volumes/Trastero/iCloud
```

Puedes ejecutar `rclone` por cada cada directorio: 

```shell
rclone sync --copy-links Baul:fotos Trastero:Baul/fotos
rclone sync --copy-links Baul:gestión Trastero:Baul/gestión
rclone sync --copy-links iCloud:priv Trastero:iCloud/priv
```

Otra opción es crearse un fichero de filtraje: `filter-from-Baul.txt` donde especifico qué quiero excluír e incluir:

* Fichero `filter-from-Baul.txt`

```config
- .DS_Store
- _gsdata_
- .DocumentRevisions-V100
- .Spotlight-V100
- .TemporaryItems
- .Trashes
- .fseventsd
+ /fotos**
+ /gestión**
- *
```

* Primero hago un `check` y luego el `sync`:

```shell
rclone check --progress --copy-links --filter-from ~/.config/rclone/filter-from-Baul.txt Baul: Trastero:
rclone sync --progress --copy-links --filter-from ~/.config/rclone/filter-from-Baul.txt Baul: Trastero:
```

<br/>

### Sincronización con Google Drive

Para sincronizar tus directorios con Google Drive, utiliza el siguiente comando de ejemplo:

```shell
rclone sync /ruta/al/priv GoogleDrive:/carpeta-en-google-drive
rclone sync /ruta/al/work GoogleDrive:/carpeta-en-google-drive
rclone sync /ruta/al/Negativos GoogleDrive:/carpeta-en-google-drive
rclone sync /ruta/al/Baul GoogleDrive:/carpeta-en-google-drive
```

Asegúrate de reemplazar `/ruta/al/priv`, `/ruta/al/work`, `/ruta/al/Negativos`, y `/ruta/al/Baul` con las rutas correctas de tus directorios locales y `GoogleDrive:/carpeta-en-google-drive` con la ubicación deseada en Google Drive.

<br/>

### Sincronización con un Ordenador Remoto

Para sincronizar tus directorios con un ordenador remoto que ejecute rclone servidor, puedes utilizar el siguiente comando de ejemplo:

```shell
rclone sync /ruta/al/priv OrdenadorRemoto:/ruta/en/el/servidor/priv
rclone sync /ruta/al/work OrdenadorRemoto:/ruta/en/el/servidor/work
rclone sync /ruta/al/Negativos OrdenadorRemoto:/ruta/en/el/servidor/Negativos
rclone sync /ruta/al/Baul OrdenadorRemoto:/ruta/en/el/servidor/Baul
```

Reemplaza `/ruta/al/priv`, `/ruta/al/work`, `/ruta/al/Negativos`, `/ruta/al/Baul`, `OrdenadorRemoto`, y `/ruta/en/el/servidor` con las rutas y nombres de servidor correctos.

Con estos comandos, puedes mantener tus directorios sincronizados tanto en la nube como en un servidor remoto. Rclone te proporciona una forma eficaz de gestionar tus datos en macOS y Linux, permitiéndote respaldarlos y mantenerlos actualizados en múltiples ubicaciones.

En resumen, rclone es una herramienta esencial para cualquier usuario que necesite sincronizar y respaldar datos en macOS y Linux. Su versatilidad y facilidad de uso hacen que sea una elección sólida para la gestión de archivos en la nube y la sincronización entre dispositivos.

<br/>

### Trabajar en modo gráfico.

<br/>

#### GUI Experimental embebido en `rclone`

Existe un [GUI experimental](https://rclone.org/gui/) que puedes instalar para trabajar en modo gráfico. Basta con ejecutar el siguiente comando, que se bajará todo lo necesario y arrancará un servidor web local. Arranca un navegador y se conecta (puedes evitarlo con `--rc-web-gui-no-open-browser`). 

En este ejemplo pido que use un usuario/password concretos y que sea "verbose", cambia el usuario y la contraseña a lo que quieras. También puede funcionar sin autenticación con `--rc-no-auth`


```shell
rclone rcd --rc-web-gui --rc-user luis --rc-pass mipase -vv
:
2023/11/18 12:38:47 DEBUG : rclone: Version "v1.64.2" starting with parameters ["rclone" "rcd" "--rc-web-gui" "--rc-user" "luis" "--rc-pass" "mipase" "-vv"]
2023/11/18 12:38:47 DEBUG : Current tag: v2.0.5, Release tag: v2.0.5
2023/11/18 12:38:47 NOTICE: Web GUI exists. Update skipped.
2023/11/18 12:38:47 NOTICE: Serving Web GUI
2023/11/18 12:38:47 INFO  : Using --user luis --pass XXXX as authenticated user
2023/11/18 12:38:47 NOTICE: Serving remote control on http://127.0.0.1:5572/
2023/11/18 12:38:47 DEBUG : login_token "bHVp12343535hc2U="
2023/11/18 12:38:47 INFO  : /: 127.0.0.1:59654: Unauthorized request from
:
```

{% include showImagen.html 
      src="/assets/img/posts/2023-11-13-rclone-01.png" 
      caption="Login en el GUI Experimental" 
      width="500px"
      %}
{% include showImagen.html 
      src="/assets/img/posts/2023-11-13-rclone-02.png" 
      caption="GUI Experimental" 
      width="500px"
      %}

<br/>

#### RcloneBrowser

Otra opción, si quieres una versión estable, es [RcloneBrowser](https://kapitainsky.github.io/RcloneBrowser/), un GUI multi plataforma que soporta macOS, GNU/Linux, la familia BSD y Windows. 

{% include showImagen.html 
      src="/assets/img/posts/2023-11-13-rclone-03.png" 
      caption="Logo del proyecto" 
      width="500px"
      %}

Para instalarlo en macOS, sigue estos pasos:

1. Descarga la última versión desde https://github.com/kapitainsky/RcloneBrowser/releases. En el momento de la publicación utilicé `rclone-browser-1.8.0-a0b66c6-macos.dmg`

2. Al ejecutarlo configuro el path al ejecutable y la ubicación del fichero de configuración

{% include showImagen.html 
      src="/assets/img/posts/2023-11-13-rclone-04.png" 
      caption="Configuración básica" 
      width="500px"
      %}


<br/>

### Actualización

Para tenerlo actualizado a la última versión, puedes utilizar el siguiente comando:

* En macOS

```shell
brew update
brew upgrade
```

* En Linux

```shell
apt update && apt upgrade -y 
```

* Para actualizar el GUI experimental: 

```shell
rclone rcd --rc-web-gui --rc-web-gui-update
# Si el GUI está roto se puede forzar el update con `--rc-web-gui-force-update`
```



