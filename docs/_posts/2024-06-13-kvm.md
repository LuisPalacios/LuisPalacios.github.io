---
title: "KVM por software"
date: "2024-06-13"
categories: software
tags: linux windows mac kvm software teclado rat´ón
excerpt_separator: <!--more-->
---

![logo user](/assets/img/posts/logo-barrier.svg){: width="150px" height="150px" style="float:left; padding-right:25px" }

En entornos donde se requiere operar múltiples ordenadores de forma simultánea, la eficiencia es clave. Existen varios productos que permiten imitar la funcionalidad de un conmutador KVM (Keyboard, Video, Mouse), que históricamente permitía utilizar un solo teclado y ratón para controlar varios ordenadores girando físicamente un dial. En este apunte describo cómo instalo y utilizo Barrier, una solución KVM por software, sin necesidad de hardware adicional.

Mi caso de uso consiste en controlar con un solo teclado y ratón tres ordenadores. Dos de ellos son de sobremesa, un mac y un PC con windows. El tercero es un PC portatil Windows/Linux. La dificultad radica en el Mac, donde me encontré con un reto curiso y casi insuperable.

<br clear="left"/>
<!--more-->

## Introducción

Es muy importante saber y decirle a Barrier dónde están ubicados cada uno de ellos respecto al resto, de modo que el ratón fluja entre las pantallas de forma lógica. Hay que ejecutar el software en los tres y uno de ellos hará de servidor y el resto de clientes. Se comunican por la red local y cada ordenador debe tener un nombre:

- **slimbook** (Linux X11)
- **macmini** (macOS)
- **kymera** (Windows 11)

Distribución de los monitores

```text
 +---------+  +----------+  +----------+
 |Laptop   |  | Mac      |  | PC(Win)  |
 |slimbook |  | macmini  |  | kymera   |
 |cliente  |  | cliente  |  | SERVIDOR |
 +---------+  +----------+  +----------+

```

### Servidor

Aquí es donde está el reto. Si elijo el Mac como Servidor, su teclado manda y carece de la tecla física AltGr para introducir caracteres internacionales. Apple los genera con sus teclados usando la tecla Opción (equivale a Alt). Si haces que el servidor sea el Mac, cuando estás controlando un PC (Windows o Linux) e intentas mandar esos caracteres simplemente NO FUNCIONAN. Al revés sí, cuando el PC es el Servidor (da igual Widnows o PC) con un teclado que tiene AltGr, entonces todos contentos (con ciertos ajustes).

Hubiese preferido configurar el Mac como Servidor (contaría con todas las virguerías de su Trackpad), pero como he dicho, si el Mac es el Servidor no puedes generar (cuando el teclado pasa al PC) las AltGr Keys `\|@#[]{}~€¬` ni ` < > `. He dedicado muchas horas a investigar este tema y no consigo encontrar la solución.

El servidor de Barrier se ejecutará en **kymera** (Windows 11).

***Windows 11***:

Descargo Barrier desde su [página oficial de GitHub](https://github.com/debauchee/barrier/releases). Selecciona la versión adecuada para Windows e instalo la aplicación. Si al instalar me pregunta `Enable autoconfig and install Bonjour`, le digo que Sí.

- Abro Barrier y selecciona la opción **"Servidor"**.
- Quito la opción **"AutoConfig"** y **desactivo SSL**

Utilizo la opción de [fichero de configuración](https://gist.github.com/LuisPalacios/ff4ea787a524fc256ae9d71a127fdcfd) para el Servidor.

### Clientes

En el MacOS (macmini), descargo el DMG desde la [página de releases](https://github.com/debauchee/barrier/releases). En Linux lo instalo con `sudo apt install -y barrier`

- Abro Barrier y selecciona la opción **"Cliente"**.
- En las opciones avanzadas introduzco el **nombre del equipo** y **quito SSL**.
- Configuro "autotal"

Dejo aquí el ejemplo de configuración del Mac, siendo del del portatil `slimbook` idéntico (solo cambia el nobmre del equipo)

{% include showImagen.html
      src="/assets/img/posts/2024-06-13-kvm-01.png"
      caption="Configuración como cliente"
      width="200px"
      %}
{% include showImagen.html
      src="/assets/img/posts/2024-06-13-kvm-02.png"
      caption="Configuración de la preferencias"
      width="200px"
      %}

Si hay problemas de conexión, verifica los firewalls y las reglas de red que puedan estar bloqueando el puerto predeterminado de Barrier (habitualmente el 24800).

## Trucos

### El teclado

Ayuda mucho si tu teclado tiene serigrafiadas la teclas de Windows y Mac a la vez. En mi caso uso un teclado que lo tiene, se trata del Logitech K380 que conecto por Bluetooth al windows.

Para que la experiencia sea correcta, en mi [fichero de configuración](https://gist.github.com/LuisPalacios/ff4ea787a524fc256ae9d71a127fdcfd) para el Servidor (`kymera`) verás en la sección del Mac `macmini` que he reconfigurado y hecho una asociación para cambiar lahubicación de las tecla de control:

```text
macmini:
  alt = super
  super = alt
  altgr = alt
  :
```

### Unificar las teclas de control

Me refiero a decidir entre usar Ctrl+<tecla> o Cmd+<tecla> en todas las pantallas (mientras que estoy con Barrier). Tenía que decidir una de las dos, y la decisión ha sido fácil. Por desgracia, en los Mac es "obligatorio" usar CMD+<tecla>, intentar cambiarlo es un infierno.

La decisión es usar CMD+<tecla> en todos los SO's, por lo tanto solo me queda remapear en Windows y en Linux. Por ejemplo, que CMD+C sea copiar tanto en Mac (lo es por defecto) como en Windows y Linux.

#### Windows: PowerToys

En Windows 11 he usado *Microsoft PowerToys* que me permite remapear unas cuantas combinaciones de teclas. Funciona excepcionalmente bien

1. **Descarga**: Microsoft PowerToys desde la [página oficial de GitHub](https://github.com/microsoft/PowerToys/releases).
2. **Instalación**: Ejecuta el instalador y seguir las instrucciones en pantalla.
3. **Abrir PowerToys**: **"Keyboard Manager"** en el panel izquierdo.
4. **Habilitar Keyboard Manager**: Asegúrate de que la opción **"Enable Keyboard Manager"** esté activada.
5. **Remapear Atajos de Teclado**: **"Remap a Shortcut"**.
   - Añado los siguientes remapeos:
     - **Alt + A** → **Ctrl + A** (Seleccionar todo)
     - **Alt + C** → **Ctrl + C** (Copiar)
     - **Alt + F** → **Ctrl + F** (Buscar)
     - **Alt + N** → **Ctrl + N** (Nueva ventana)
     - **Alt + Q** → **ALt(left) + F4** (Cerrar App)
     - **Alt + R** → **Ctrl + R** (Recargar)
     - **Alt + S** → **Ctrl + S** (Salvar)
     - **Alt + T** → **Ctrl + T** (Nueva pestaña)
     - **Alt + V** → **Ctrl + V** (Pegar)
     - **Alt + W** → **Ctrl + W** (Cerrar ventana)
     - **Alt + X** → **Ctrl + X** (Cortar)
     - **Alt + Z** → **Ctrl + Z** (Undo)
     - **Alt + Shift + 4** → **Win (left) + Shift + S** (Captura de pantalla)
     - *(Añadí otros remapeos según fuí trabajando y necesitándolos)*

{% include showImagen.html
      src="/assets/img/posts/2024-06-13-kvm-03.png"
      caption="Remapeos para Windows"
      width="500px"
      %}

#### Linux: Solución parcial

X11: Es engorroso, no es tan sencillo como en Windows. Tengo pendiente documentarlo

Wayland: No funciona Barrier, así que lo dejo aquí pendiente para futura investigación.
