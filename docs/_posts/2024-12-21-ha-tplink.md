---
title: "HA y TPLink"
date: "2024-12-21"
categories: domótica
tags: ha hass gome assitant iot switch poe
excerpt_separator: <!--more-->
---

![Logo CRLF](/assets/img/posts/logo-hass-switch.svg){: width="150px" style="float:left; padding-right:25px" }

En este apunte explico cómo controlar un puerto PoE en un switch TP-Link (`TL-SG108PE`) desde Home Assistant. Dado que estos pequeños conmutadores no soportan `SNMP` voy a usar `curl` para autenticarme, encender, apagar o consultar el estado de un puerto específico. El caso de uso es poder encender o apagar una cámara PoE ReoLink conectada a uno de los puertos desde Home Assistant.

<br clear="left"/>
<!--more-->

## Introducción

Como decía, se trata de un pequeño switch `TL-SG108PE`. Para los ejemplos siguientes, su nombre de host es `sw-despacho-mesa.parchis.org`. La secuencia de trabajo con él víá `curl` consiste en autenticarse primero y después pedir acciones como encender, apagar o consultar el estado de un puerto.

{% include showImagen.html
      src="/assets/img/posts/2024-12-21-ha-tplink-01.svg"
      caption="Esquema de conexión"
      width="700px"
      %}

Este equipo utiliza autenticación basada en **Sesión del Servidor** (en vez de basada en Cookies). Al autenticarse con el primer `curl`, el servidor vincula la dirección IP del cliente o algún identificador único (como un token) a una sesión activa y si las solicitudes posteriores provienen del mismo cliente en un tiempo razonable, el servidor las considera parte de la misma sesión, razón por la que el segundo comando `curl` funciona.

| Nota: si tienes otro switch y usase sesiones basadas en Cookies el truco consiste en salvar la cookie en el primer `curl` (opcion `-c`) y en el segundo enviarla con la opción `-b`. |

Los comandos POST y GET que verás a continuación los descubrí conectándome desde el navegador y capturando el tráfico con [Wireshark](https://www.wireshark.org/).

**Autenticación**: Este es el comando que nos autentica con el switch. Es necesario ejecutarlo antes y por cierto, si ya se encontrase autenticado, no pasa nada por ejecutarlo de nuevo.

```bash
curl -X POST "http://sw-despacho-mesa.parchis.org/logon.cgi" \
-H "Content-Type: application/x-www-form-urlencoded" \
--data-urlencode "username=<usuario>" \
--data-urlencode "password=<contraseña>" \
--data-urlencode "cpassword=" \
--data-urlencode "logon=Login"
```

**Encender/Apagar el Puerto PoE**: Estos son los dos comandos, la clave está en el valor de `state`. El primero enciende el puerto y el segundo lo apaga. La cámara se encenderá o apagará al recibir o dejar de recibir energía.

```bash
curl --basic --request GET "http://sw-despacho-mesa.parchis.org/port_setting.cgi?portid=1&state=1&speed=1&flowcontrol=0&apply=Apply"

curl --basic --request GET "http://sw-despacho-mesa.parchis.org/port_setting.cgi?portid=1&state=01&speed=1&flowcontrol=0&apply=Apply"
```

**Obtener el estado de un puerto**: Es posible interrogar al Switch para ver el estado de un puerto concreto. En el siguiente ejemplo averiguo el estado de todos los puertos y muestro el valor del primero (cambia el `$1`  por el puerto que te interese). Devolverá `1=encendido` o `0=apagado`.

```bash
curl -s --basic --request GET "http://sw-despacho-mesa.parchis.org/port_setting.cgi" | grep -oP 'state:\[\K[^\]]+' | awk -F, '{print $1}'
```

## Home assistant

En el fichero `/homeassistant/configuration.yaml` incluyo lo siguiente:

```yaml
command_line: !include command_line.yaml
```

Este es mi fichero `command_line.yaml`

```yaml
# command_line.yaml
# Para ejecutar comandos externos

# Creo un objeto switch para poder conmutar ON/OFF el puerto del switch
#
- switch:
    name: ReoLink Despacho Sensor
    command_on: >
      curl -X POST "http://sw-despacho-mesa.parchis.org/logon.cgi" -H "Content-Type: application/x-www-form-urlencoded" --data-urlencode "username=luis" --data-urlencode "password=<CONTRASEÑA>" --data-urlencode "logon=Login" &&
      sleep 1 &&
      curl --basic --request GET "http://sw-despacho-mesa.parchis.org/port_setting.cgi?portid=1&state=1&speed=1&flowcontrol=0&apply=Apply" &&
      sleep 5
    command_off: >
      curl -X POST "http://sw-despacho-mesa.parchis.org/logon.cgi" -H "Content-Type: application/x-www-form-urlencoded" --data-urlencode "username=luis" --data-urlencode "password=<CONTRASEÑA>" --data-urlencode "logon=Login" &&
      sleep 1 &&
      curl --basic --request GET "http://sw-despacho-mesa.parchis.org/port_setting.cgi?portid=1&state=0&speed=1&flowcontrol=0&apply=Apply" &&
      sleep 5
    command_state: >
      ping -c 1 -W 2 camara-despacho.parchis.org | grep "1 packets received" | wc -l
{% raw %}    value_template: '{{ value == "1" }}'{% endraw %}
    unique_id: cmd_line_reolink_despacho_sensor

# Creo un objeto binary_sensor para conocer es estado de la cámara
#
- binary_sensor:
    name: ReoLink Despacho Conectividad
    command: 'ping -c 1 -W 2 camara-despacho.parchis.org | grep "1 packets received" | wc -l'
    device_class: connectivity
    payload_on: 1
    payload_off: 0
    unique_id: cmd_line_reolink_despacho_conectividad

```

A continuación muestro el diagrama de secuencia.

{% include showImagen.html
      src="/assets/img/posts/2024-12-21-ha-tplink-02.svg"
      caption="Ejemplo de la secuencia de encendido"
      width="700px"
      %}

A partir de aquí ya puedes añadir las entidades al Dashboard que quieras y/o incluirlas en cualquier automatización para controlar el estado de la encendido o apagado de la cámara. Eso sí, dale tiempo a la ejecución, ten en cuenta que es asíncrono, encender la cámara tarda unos segundos y por lo tanto los cambios de estado tardarán en reflejarse.

{% include showImagen.html
      src="/assets/img/posts/2024-12-21-ha-tplink-03.png"
      caption="Ejemplo de panel"
      width="600px"
      %}
